孩子任务规划与时间轴改进
背景与目的

最近合并的代码初步实现了孩子端的任务规划与记录功能，支持从任务库中选择任务规划到当天并提交完成情况，与积分奖励机制挂钩
GitHub
GitHub
。然而，目前孩子端功能还有所欠缺：无法直接新增自定义任务（任务库新增任务仅限家长/管理员使用
GitHub
），积分奖励逻辑仍有不完善之处（如任务完成后积分即时计入但家长拒绝审批时未扣除
GitHub
），以及数据模型中一些扩展字段尚未充分利用（如周期性任务、优先级等
GitHub
）。另外，时间轴视图的交互规划尚未完整实现，目前仅有基础数据接口和设计概念，但前端拖拽排程功能被简化或移除
GitHub
。为提升孩子端的自主规划体验和系统完备性，需要对上述方面进行改进。

功能描述

针对孩子端任务规划与记录模块，拟完善以下功能：

自定义任务创建：允许学生用户新增自定义任务，包括任务名称、描述、类别、预计时间、难度和奖励积分等，扩充任务库。

积分逻辑完善：改进任务完成后的积分结算流程，在家长审批通过后再正式累加积分，审批拒绝则撤销预支积分；支持家长追加奖励积分时同步更新；确保不同情况下积分计算和存储一致可靠。

数据模型扩展应用：利用现有数据模型支持周期性任务和任务优先级。允许将任务标记为每日/每周重复，自动生成后续计划；优先级和时间偏好字段影响任务列表排序或日程安排，便于学生聚焦重要任务。

时间轴视图：新增或完善可视化的日程时间轴界面，将当天任务以时间线方式呈现。学生可以拖拽任务卡片到时间轴上的特定时段进行安排，直观规划一天的任务时间，避免冲突并支持提醒设置。

具体需求项

允许学生新增任务：在任务库界面为学生提供“新增任务”入口（或申请创建任务流程）。填写任务名称、描述、类别、预计耗时、难度等信息，并设定基础积分或使用难度/耗时自动计算积分。
GitHub
GitHub
新任务提交后默认仅对自己和家长可见（isPublic=false），并存储为该学生创建的任务。

积分奖励流程优化：调整任务完成后积分处理逻辑：

当学生标记任务完成时，系统计算出基础积分及可能的奖励（如字数、时长奖励等）并暂存于DailyTask的pointsEarned字段
GitHub
GitHub
；界面提示“获得X积分（待家长审核）”
GitHub
。用户总积分不在此刻更新，以防审批不通过。

家长在审批界面通过任务时，后台将该任务approvalStatus设为approved，并将此前暂存的积分正式计入学生总积分；若家长额外奖励了加分（bonusPoints），则在此时一并增加
GitHub
。审批拒绝时，将DailyTask的approvalStatus设为rejected，并回退之前暂存的积分（从学生总积分中扣除对应分值）以保持一致
GitHub
。同时将任务状态从“已完成”重新标记为“进行中”或“计划中”，供学生后续处理。

确保上述流程在前后端状态保持一致：审批后学生端任务列表相应更新为“已通过”或“已拒绝”，积分数正确反映最终结果。

周期性任务支持：提供在创建任务或规划任务时设置“重复”选项的功能，例如“每日重复”或“每周固定几天”。后台数据模型已包含isRecurring和recurringPattern字段
GitHub
用于描述重复类型和间隔。实现方案可以是：当学生勾选每日/每周重复时，自动为后续日期生成对应的DailyTask记录，或在每新一天到来时根据模板任务生成当天任务。需确保不会重复创建已有的重复任务记录。界面上对重复任务做标记说明，方便识别其周期属性。

任务优先级与时间偏好：在任务规划时允许学生为任务设定优先级（高/中/低）和时间偏好（如偏好上午/下午完成）。利用DailyTask中的priority和timePreference字段存储该信息
GitHub
。前端在展示今日任务列表时，可根据优先级排序任务或以不同样式突出高优先级任务；在时间轴视图中，也可据此提示最佳安排时段。例如，高优先任务在时间轴顶部或以醒目颜色显示。

时间轴视图：构建“时间轴”页面用于日程可视化安排：

界面布局：页面展示从早到晚的时间刻度轴，以及当日所有已规划任务（DailyTask状态为planned/in_progress）卡片。每个任务卡显示名称、预计时长和积分等。学生可以将任务卡拖动到时间轴上的某个时间段来设置plannedTime和plannedEndTime。示例设计中时间轴区域提示“可拖拽任务到这里安排时间”，需要实现对应交互。

拖拽与冲突检测：实现拖拽任务卡到时间轴并保存其开始时间（以及自动计算结束时间）。调用后端冲突检查接口/dailyTasks/check-conflicts验证所选时段是否与已有任务重叠
GitHub
GitHub
。若有冲突，前端给予提示并可选择调整时间或取消。确保同一时间段不出现重叠的任务安排。

数据同步：拖拽排定时间后，通过调用更新DailyTask接口保存plannedTime/plannedEndTime等信息，刷新周计划数据。时间轴应与任务列表保持同步，未安排时间的任务仍可列表显示，已安排的在时间轴上显示其具体时间段。支持修改：学生可拖动已安排任务调整时间段，或拖出时间轴恢复为未定时状态。

提醒和完成：如有reminderTime设置（比如任务开始前提示），可集成提醒功能（可能利用浏览器通知或日历事件，此部分可后续扩展）。学生在时间轴视图中直接勾选标记任务完成时，流程与当前“今日任务”列表一致，仍需附证据则弹出证据上传，对无需证据任务直接完成并即时反馈积分。

验收标准

 学生可新增任务：学生帐号登录时，在任务库中可以看到“新增任务”按钮或入口。填写必要信息后提交，新任务立即出现在任务库列表中
GitHub
GitHub
，学生随后可将其规划到当日。新建任务的积分计算符合设定规则（手动输入或根据难度自动计算）。

 规划任务出现于当日列表：学生成功规划任务（包括自定义任务）后，无需刷新即可在“今日任务”或“任务规划”列表中看到新增的当日任务条目，状态为“📋计划中”。数量计数和总积分/总时间统计正确更新
GitHub
GitHub
。

 任务完成积分反馈准确：学生在前端标记任务完成后：

若任务要求提交证据，则前端提示“已提交，获得X积分（待家长审核）”
GitHub
，学生总积分暂不改变；任务状态显示为“✅已完成/待审批”。

若任务无需证据，则前端直接恭喜获得X积分
GitHub
，学生总积分即时增加相应值。任务状态显示为“✅已完成”，审批状态自动视为通过。 (视产品决定，无证据任务是否也需家长确认，可按最终规则验收)。

 家长审批流程：在家长端可看到孩子提交的每条任务记录及其证据；对待审批任务执行“通过”或“拒绝”后，学生端状态相应更新为“已通过”或“已拒绝”，并在任务详情上显示家长批注/原因。通过后学生总积分增加应与任务积分（含奖励+额外奖励）一致；拒绝后学生总积分与提交前保持一致（即撤销了临时积分）。后台数据库中DailyTask的approvalStatus和pointsEarned等字段与前端呈现吻合无误。尤其拒绝情况下，验证学生总积分回退逻辑正确无误，不会出现积分快照不同步的问题。

 周期任务生成：当学生将某任务设为每日或每周重复时，系统能按设定周期自动产生后续的DailyTask计划。例如勾选“每日”则未来若干天同一任务都会出现在每日计划中（可限制只生成最近一周，滚动生成）；勾选“每周一、三”则之后每个对应星期该任务出现在计划列表。验收时，模拟创建一个每周重复任务，确认在接下来预期的日期上都自动有该任务（状态为计划中）。若学生删除或修改其中某一天的任务，不影响模板对后续日期的生成。

 优先级及排序：学生在规划任务时能设置优先级，高优任务在当天任务列表中明显标识（例如特殊图标或字体颜色），列表默认按照高→低优先排序。时间偏好设置目前不直接影响系统行为，但在任务详情中可记录保存。后续如有智能推荐或自动排程，可利用该信息。验收以UI显示和数据库记录为准：在创建/编辑任务时设置不同优先级，保存后前端列表顺序正确，数据模型中的priority字段更新正确。

 时间轴视图初步实现：应用新增“时间轴”页面（或在“任务规划”中切换到日程视图），默认显示当天0点至24点的时间轴刻度。当天已有计划任务以待安排状态列出在侧栏，提示可拖拽。将任务拖入时间轴后，该任务在时间轴上出现一个块状日程条，长度与任务预计时长相对应，位置与所放置开始时间吻合。拖动任务后刷新页面或切换日期，依然能看到先前安排结果（说明plannedTime存储成功）。多任务拖放情况下，若存在时间重叠冲突，系统能拦截并提示冲突任务名称
GitHub
，不允许松开放置或要求先调整已有任务时间。验收时，可尝试将两个任务拖到相同时间，确保有冲突提示；无冲突的拖放操作均能成功保存。

 日程与任务列表同步：在时间轴界面标记任务完成、删除任务等操作后，“今日任务”列表同步更新相应状态；反之，在传统列表视图完成任务，时间轴视图中该任务标记为已完成（例如打勾或改变样式）。保证同一任务的数据在不同视图一致。跨天切换查看时，时间轴能正确显示所选日期的任务安排及完成情况。

 性能与易用性：在添加自定义任务、批量生成周期任务以及渲染时间轴时，界面交互流畅不卡顿。对于重复任务生成机制可能带来的数据量增多，需验证不会明显影响加载速度。UI上新增的元素（按钮、提示）符合整体风格，操作指引清晰，用户容易上手。

优先级/时间计划

第一阶段（高优先，尽快迭代）：实现自定义任务创建和积分逻辑完善。这两项直接关系核心用户体验，应尽快完成。预计~1周完成开发和测试。发布后学生可自由添加任务，积分结算更加严谨可靠，解决当前积分可能不一致的问题。

第二阶段（中优先，2周左右）：开发时间轴视图及拖拽排程功能。此功能技术难度较高（涉及复杂的前端交互和冲突检测），但对提升产品直观性价值大。可分步实施：先上线静态时间轴查看功能，再逐步开放拖拽交互和冲突提示。期间应充分测试不同浏览器兼容性和交互细节。

第三阶段（中等优先，2周）：完善周期任务和优先级支持。周期任务涉及一定业务规则和批处理，优先级影响排序细节，相对独立可并行进行。此阶段着重后台逻辑和计划任务生成策略，确保不会产生重复或遗漏。开发完成后配合时间轴功能一起发布，提供完整的任务规划体验。

上述阶段可以部分并行，但建议按照依赖关系推进：阶段1完成后，基本功能稳定，再进行阶段2 UI 大改进；阶段3在后台支持充分的基础上与阶段2收尾结合测试。整体优先级以修正现有不足（阶段1）为首，交互提升（阶段2）次之，功能扩展（阶段3）随后。目标是在下个月底前完成所有改进，及时投入下一轮暑期计划使用。

其他备注

角色权限：开放学生创建任务功能时，可考虑引入家长审核机制——例如学生新增的任务默认标记为私人或需家长确认后才公开加入任务库，以防不当内容。但在当前家庭场景下，亦可先允许学生自由添加自用任务，由家长在每日任务完成审核环节顺带监督其任务安排。

数据迁移：若之前有未处理的积分记录（例如已完成但家长未审批且积分已发放的情况），在上线新积分逻辑时需要迁移修正。这可能涉及将这些任务的学生总积分扣回并标记待审批。需脚本或手动调整数据库，确保历史数据一致性。

测试覆盖：为避免引入新缺陷，所有新增改动应增加单元测试或集成测试。特别是积分结算和时间冲突部分，可参考现有积分计算测试用例
GitHub
GitHub
完善更多场景，确保复杂规则下系统行为符合预期。

UI/UX：时间轴界面的设计要充分考虑移动端适配和操作便捷性。如果拖拽在小屏设备上体验不佳，可能需要提供替代方案（如下拉选择时间）。优先级高的任务在UI上给予醒目提示，建议和设计师协作优化样式。

后续展望：在完成以上改进后，可进一步考虑添加任务提醒、排行榜、成长成就等功能，与现有积分和时间轴体系结合，构建更丰富的激励闭环，持续提升孩子的自我管理积极性。