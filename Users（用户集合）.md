## Users（用户集合）

**结构与字段：**Users 集合用于存储用户账户信息，包含用户 ID、邮箱、显示名称、角色（'student'或'parent'）、关联的家长或子女、积分余额等关键字段[_[1]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L3-L10)。每个用户还记录头像链接（avatar，可选）、当前连续完成任务的天数（currentStreak）以及勋章获得情况（青铜/白银/黄金/钻石，布尔值表示是否达成）[_[2]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L12-L19)。此外还有创建时间和更新时间戳用于审计[_[2]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L12-L19)。后台实际存储时还包括密码散列（password），这一字段在接口定义中体现在 UserDocument 类型中[_[3]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L23-L25)。

**字段完整性与一致性：**整体来看，Users 文档涵盖了用户账户所需的大部分信息，字段设计较完善。需要注意的是，目前类型定义中角色仅列出 'student' 和 'parent'[_[4]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L5-L8)，但初始化脚本创建了 role 为 'admin' 的系统管理员用户[_[5]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L350-L358)。应当在类型和验证中补充对 'admin' 角色的支持，以保持一致性。此外，管理员账户在初始化时没有设置密码[_[6]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L350-L359)，会导致 UserDocument 不完整，须在上线前为管理员账号设定密码（或通过脚本插入散列值）以确保安全登录。家长与学生的关联通过 parentId 和 children 字段双向维护[_[7]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L6-L10)；在演示数据中创建学生后会回写家长文档的 children 列表以保持一致[_[8]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/create-demo-users.js#L70-L74)。这种冗余设计方便查询但需严格保证原子更新，防止出现家长记录的 children 列表缺少某个学生、或学生的 parentId 无效等不一致情况。

**索引与性能：**Users 集合在关键字段上已设计索引，有助于性能和数据完整性。例如，邮箱字段有唯一索引用于登录校验[_[9]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L31-L39)；角色字段和 parentId 字段也建立了索引便于基于角色筛选用户及查找家长-孩子关系[_[10]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L43-L51)[_[11]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L59-L64)。同时，为了排行榜查询，points 字段配合角色设有降序复合索引[_[12]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L51-L58)，可以高效获取积分最高的学生列表等[_[13]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md#L22-L25)。这些索引的设计表明系统已考虑常用查询模式，基本不存在明显的索引缺失问题。

**存在的问题与建议：**用户集合主要改进点在于权限与软删除方面。目前用 role、parentId/children 来划分权限边界，应用层也会据此检查访问权限（例如仅家长能查看其孩子的数据）[_[14]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L140-L148)。这一设计清晰合理，但在上线前应确保所有相关接口都正确使用了这些字段进行权限校验，避免越权访问。对于删除用户的场景，目前没有 deleted 或 active 标记，删除用户将需要物理删除文档，这可能导致其关联的任务等数据孤立。建议增加一个布尔字段如 isDeleted 或 active 来支持软删除，当有用户退出或需要停用账号时标记状态而非直接移除数据，以便保留其任务和积分记录用于审计。此外，可考虑在家长-学生关联上实施引用完整性检查：例如在删除或停用用户时，级联更新或提醒清理相关引用，防止残留无效的 parentId 或 children。总的来说，Users 结构已经较为健全，在完善上述细节（如补齐 admin 角色支持、管理员密码、软删除机制）后即可满足真实用户试用需求。

## Tasks（任务集合）

**结构与字段：**Tasks 集合定义了可规划的任务模板。字段包括任务 ID、标题、描述、类别（如 'exercise'、'reading' 等）、活动标识（用于积分计算的标准化代号）、难度（容易、中等、困难）、预估所需时间、基础积分、是否需要提交证明及证明类型（文本/照片/视频）、标签、创建者用户ID、是否公开等[_[15]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L27-L35)[_[16]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L40-L48)。任务还包含扩展计划字段，例如优先级、偏好时间段、是否周期性任务及重复模式等，可选字段允许更灵活的任务计划[_[16]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L40-L48)。同样地，每条任务记录具有 createdAt 和 updatedAt 时间戳用于记录创建和更新时间[_[17]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L48-L52)。

**字段合理性与一致性：**大部分任务字段设计合理，涵盖了任务定义和筛选所需的信息。但审查发现几个不一致之处：首先，接口定义中任务包含一个 activity 字段用于标识具体活动类型，以便于根据不同活动应用积分规则[_[18]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L29-L37)。然而初始化插入的基础任务文档并未设置该字段，只有 category 和通用描述[_[19]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L30-L39)。例如，“阅读经典故事”任务只有类别reading，但缺少应有的 activity 标识。这意味着如果积分规则系统依赖任务的 activity 字段来精细计算积分，那么当前数据可能不完整，会回退使用默认值 'general'[_[20]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L24-L31)。建议在上线前为所有任务补齐 activity 字段（可以将其设为和类别类似的标识或更具体的活动名称），或者调整积分计算逻辑确保没有该字段时以类别或其他方式处理，否则可能出现找不到对应积分规则的问题[_[21]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L98-L101)。

另外，任务的基础积分 (points) 字段和积分规则配置可能存在重复定义或不一致。当前每条任务有固定的points值，而系统也初始化了按类别的积分计算规则（基础分和难度系数等）[_[22]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L216-L225)[_[23]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L240-L248)。观察到某些任务的设定积分未严格遵循规则系数（例如阅读类一个中等难度任务基础分10却设为15分，略高于按规则应得的12分）[_[22]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L216-L225)[_[24]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L46-L54)。这可能是出于手动调整，但如果同时存在静态积分和动态规则，两者需保持一致，否则真实计算时会令人困惑。**建议：**明确积分的来源，要么始终根据PointsRule动态计算任务完成所得积分，要么确保Tasks表中的points与规则配置一致并作为主要依据。如果采用动态计算，可以考虑移除任务中的静态points字段，或仅将其用于初步估算显示，并在完成任务时重新计算[_[25]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L14-L22)[_[26]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L26-L34)。无论哪种方式，都应统一策略以避免数据冗余不一致。

**索引与性能：**Tasks 集合潜在的查询包括按类别或难度筛选任务、获取公共任务库、用户自建任务列表等。项目已经针对这些用例建立索引：如 (isPublic, category) 复合索引便于按类别获取公开任务模板[_[27]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L72-L76)；(category, difficulty, isPublic)索引用于任务推荐算法筛选不同难度/类别的任务[_[28]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L80-L88)；(createdBy, createdAt)索引支持查找某用户创建的任务（最新优先）[_[29]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L88-L93)。另外还有 (difficulty, points) 索引以备根据难度和积分范围分析任务分布[_[30]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L96-L101)。这些索引基本覆盖了主要查询模式，在数据量增大时能够提供良好性能。因此Tasks集合不存在明显的索引缺失问题。

**问题与改进建议：**任务集合需要关注的数据健壮性问题主要有两点：其一是字段冗余和可维护性，其二是删除和归档策略。首先，任务的一些信息在 DailyTasks 集合中重复出现（如优先级、时间偏好、重复规则等也存于每日任务以便具体日程使用[_[31]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L71-L79)）。虽然这是为了在实例层覆盖模板默认值，但务必确保任务模板更新时不会与已有每日任务计划数据冲突。对于Evidence相关字段，Task只定义需要提交证明与否及类型列表，并不存具体证明内容，设计合理。其二，目前任务没有“删除”标记或状态。一旦用户创建了任务模板，系统中将一直存在。如果某任务不再适用或输入有误，除非直接从数据库删除，否则没有办法隐藏。直接物理删除任务会带来潜在问题，例如已有引用该模板的 DailyTasks 将变成孤立引用。**建议：**引入软删除或停用机制，例如增加 isArchived 或 deleted 字段。当需要移除某任务模板时，将其标记为已归档/删除，而业务查询（如任务库展示）排除这些任务。这可避免硬删除导致的数据不一致。同时，可在DailyTasks实例中冗余存储部分任务信息（如任务标题或基础积分），以防任务模板被删除或修改名称后历史记录难以追溯原始信息。不过冗余存储也要慎重，当前设计每次获取 DailyTasks 时通过 taskId 再查任务[_[32]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L164-L173)，[_[33]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L166-L174)可以拿到最新的任务详情。如果需要保持历史一致性，可以在DailyTask记录中保存任务标题等快照信息用于审计。总的来说，Tasks 集合结构较完善，按照以上建议修正 activity 字段和积分定义一致性，并增加任务软删除策略，将使其更健壮。

## DailyTasks（每日任务集合）

**结构与字段：**DailyTasks 集合用于记录用户每天实际计划和执行的任务实例。字段包括每日任务 ID、关联的用户ID和任务模板ID、日期（YYYY-MM-DD）、任务状态（planned计划中、in_progress进行中、completed已完成、skipped已跳过）[_[34]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L62-L70)。还包含计划开始/结束时间、提醒时间等日程安排信息，以及任务优先级、时间偏好、是否属于周期性任务及重复模式等，与任务模板类似的字段用于具体这一天的安排[_[34]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L62-L70)[_[31]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L71-L79)。执行完成后，会记录完成时间 completedAt，用户提交的文字心得 evidenceText、媒体证明列表 evidenceMedia，以及一个通用的证据数组字段（包含证据类型、内容URL/文本、时间戳）[_[35]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L80-L88)。可见这里存在一定冗余：既有独立的文字和多媒体证据字段，又有一个整合的证据数组。DailyTask 还包含备注和计划时的笔记，积分相关字段如完成任务获得的积分 pointsEarned，由家长额外奖励的加分 bonusPoints（如果有），以及审批状态字段（approvalStatus待审批/已批准/已拒绝，approvedBy审批人ID，approvedAt审批时间，approvalNotes审批意见）用于家长审核任务结果[_[36]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L90-L98)。和其他集合一样，DailyTasks 也记录创建和更新时间[_[37]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L96-L98)。

**字段问题分析：**DailyTasks 的数据结构较为复杂，结合了计划、执行和审核的信息。首先，证据字段的冗余值得注意：evidenceText/evidenceMedia 与通用的 evidence 数组在语义上重叠[_[35]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L80-L88)。这可能是演进过程中字段设计调整的结果。例如早期方案可能将文字和多媒体分开存储，后来又增加了统一的证据数组。这样的重复会导致数据更新不一致的风险——如果一个任务的证明既填写了文字又在 evidence 数组中重复，或两者未同步更新，会产生困惑。**建议：**在正式上线前明确证据数据的存储方式，二选一：要么仅保留 evidenceText 和 evidenceMedia 字段（分别存放文字内容和媒体文件列表）；要么统一使用 evidence 数组对象列表。为了简化和扩展，推荐采用通用的 evidence 数组结构，删除或弃用单独的文字/媒体字段，以避免冗余。相应地，前端提交和后台读取逻辑需要调整一致。

其次，审批与积分相关字段需要验证其健壮性。DailyTask包含pointsEarned用于记录该任务最终获得的积分。对于不需家长审核的任务，完成时即可赋值；但对于需要审核的任务，当前逻辑是在提交时将其设为0等待审核[_[38]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L150-L158)[_[39]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L152-L160)。家长审批通过后再更新为实际获得积分并可加上bonusPoints[_[40]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L732-L740)[_[41]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L832-L840)。审查发现一个潜在问题：系统并未在 DailyTask 中存储“待审核的预期积分”。也就是说，孩子提交任务时如果需要审核，pointsEarned被置0，而原本应得的基础积分仅存在于即时计算的结果中并通过响应告知了前端[_[42]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L170-L178)（但未保存）。家长在审批时代码使用的 basePoints 来源却是 dailyTask.pointsEarned（此时为0）[_[43]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L733-L741)，这会导致实际奖励积分计算不正确。理想情况下，应在任务提交完成时将“未批准积分”暂存在某处（例如 DailyTask 的一个字段，如 pendingPoints 或直接保留在 pointsEarned 字段但同时标记未批准状态）。**建议：**修正审批流程的数据处理，在 DailyTask 中保留任务完成所对应的基础积分，哪怕暂不计入用户总分。这可以通过额外字段或改变pointsEarned语义实现。确保家长批准时能获取任务本该获得的积分值，否则将出现孩子完成任务但即使家长批准也得不到分的严重问题。

**索引与性能：**DailyTasks 是系统中最常查询和操作的集合之一，索引设计至关重要。当前已针对主要使用场景创建了一系列索引：按用户+日期查询每日任务列表（仪表盘视图）[_[44]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L109-L117)、按用户+状态查询任务（比如获取某用户所有已完成或待办任务）[_[45]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L117-L125)、按状态+完成时间查询（用于家长筛选所有已完成待审批的任务）[_[46]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L125-L133)[_[47]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L157-L161)、按任务ID聚合状态（分析某任务模板下的完成率）[_[48]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L133-L140)、用户+日期+状态复合索引（用于统计某段时间内用户任务完成情况）[_[49]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L141-L149)，以及用户+完成时间+积分索引（为推荐算法提供近期表现数据）[_[50]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L149-L153)等。不仅如此，还有审批状态索引专门加速家长获取待审批任务[_[47]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L157-L161)。这些索引全面覆盖了日常查询和统计分析，预计能够支撑上线后的读写性能。唯一需要留意的是**唯一约束**：目前系统通过插入前查询避免重复[_[51]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L76-L84)来确保同一用户同一天不会重复安排相同任务[_[52]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L78-L86)。然而这依赖应用层逻辑，理论上仍有并发竞态可能。可以考虑在 userId+taskId+date 上添加唯一索引，从数据库层面杜绝重复记录的插入（当前没有此索引）。总的来说，DailyTasks 的索引策略良好，查询性能有保证。

**其他健壮性检查：**权限方面，每条每日任务都关联一个 userId，系统应确保用户只能访问自己的 DailyTasks，或家长访问其孩子的 DailyTasks。实际在API中也执行了这种检查[_[14]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L140-L148)。这种设计依赖 Users 集合中的 parent-child 关系来判定权限，数据本身无法强制约束，但当前实现已足够。审计字段上，DailyTasks提供了丰富的信息：从计划到完成，每个阶段时间和状态都有记录；审批过程的人员和时间也保存下来，满足日后追溯需要。不过尚未看到类似“历史变更”数组之类的字段，意味着如果某条DailyTask被多次修改，只能从updatedAt推断最近一次修改时间，无法直接看到每次变更细节。考虑到DailyTask更多是一次性流程记录，这并非大问题。**软删除方面**，DailyTasks没有显式的 deleted 标记，若用户取消某个计划任务，目前可能的做法是将状态标记为skipped表示跳过而非真正删除。这保证了历史记录完整，但在实际使用中如果用户希望撤销尚未开始的计划任务，系统应该明确如何处理——要么将其标记为跳过（这会影响统计，如连续完成率），要么允许直接删除该记录。**建议：**在需求允许的情况下，可以增加一个状态如canceled或引入isDeleted标记来表示用户主动取消的任务计划，以区别于skipped（跳过通常表示计划执行但未完成）。这样可以避免将用户主动撤销的任务计入统计或影响习惯养成评估。另外，如前所述，应尽快消除证据字段的冗余并修正审批积分流程中的数据记录问题。只要解决这些细节，DailyTasks 数据结构能够支撑真实用户场景下的复杂工作流。

## Redemptions（积分兑换记录集合）

**结构与字段：**Redemptions 集合用于记录用户用积分兑换奖励的请求。每条记录包括唯一 ID、发起兑换的用户ID，奖励的标题和描述，所需消耗的积分数，以及当前处理状态[_[53]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L101-L109)。状态 status 为枚举值，可取 'pending'（待处理）、'approved'（已批准）或'rejected'（已拒绝）。记录还包含用户提交兑换请求的时间 requestedAt，以及兑换处理完成的时间 processedAt、处理人（家长或管理员）ID processedBy，和备注 notes 字段用于填写拒绝原因或其他说明[_[54]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L103-L111)。这个集合基本涵盖了一次积分兑换从申请到审核的全流程数据。

**字段完整性与默认值：**Redemption 文档提供了必要的信息字段，命名较自解释。不过有些命名与其他集合略有差异，例如用 requestedAt 表示创建时间，未使用通用的 createdAt，但本质含义相同。processedAt 类似于完成处理的更新时间。默认值方面，新建请求应默认状态为 pending，其他字段如 processedAt/By 在未审批前可以不存在或为空，这符合预期。需要注意的是，Redemption 目前将奖励的名称和描述直接存储在每条请求中，而没有引用一个独立的“奖励”数据源。这意味着系统并没有中央的奖励模板集合，用户提交时可能自由填写想兑换的内容（或从预定义列表中选后复制名称）。这种设计虽然灵活，但**可能导致**相同奖励的名称描述不统一、难以统计管理。我们将在“奖励”部分详细讨论这一点。

**索引与性能：**兑换记录很可能按用户或按状态来查询。当前系统已为 Redemptions 集合建立了索引：(userId, requestedAt) 用于查询某用户的兑换历史[_[55]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L170-L175)，[_[56]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L170-L178)；(status, requestedAt) 用于按状态筛选，如家长查看所有待审批请求队列[_[57]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L178-L184)。另外还有 (userId, pointsCost, status) 的复合索引用于积分消耗分析[_[58]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L186-L194)。这些索引能够支持常见用例，例如用户查看自己所有兑换记录、家长/管理员处理待审批列表，以及统计一段时间内兑换花费了多少积分等。因此性能方面没有明显问题。

**数据健壮性与改进：**首先检查积分扣减和回滚机制：当兑换被批准时，应该扣减用户相应积分，并记录一条积分交易（PointsTransaction）用于审计[_[59]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L244-L251)。类型定义已包含type: 'redemption'用于此类交易[_[60]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L8-L16)。需确保应用逻辑在将 Redemptions 状态设为 approved 时，原子地更新了 Users 表的积分值以及插入对应的 PointsTransaction，以免出现兑换成功但积分未扣的情况。类似地，若兑换被拒绝，一般不扣积分，但如果在流程中已预扣，则需返还（目前推测请求阶段未扣分，批准时才扣，这样更安全）。审阅代码/文档，尚未看到专门的兑换控制器细节，但应验证这一流程的事务性。

其次，Redemptions 集合提供了删除接口[_[61]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/ad0f407c15df9afb1c4b202bd9af4815b2d64ac2/backend/src/routes/redemptionRoutes.ts#L32-L40)。这意味着用户或管理员可以删除兑换请求记录。目前推测删除操作可能用于用户撤销尚未处理的请求。但物理删除记录将丢失该次请求的所有痕迹。**建议：**使用软删除或状态标记替代直接删除。例如新增一个状态canceled表示用户取消请求，而不是从库中移除记录。这样可以保留完整的申请/取消日志，便于审计和观察用户行为（例如频繁取消可能意味着奖励设计需调整）。如果必须物理删除，也应限制仅对未审批的请求，并谨慎处理已扣积分的情况。

最后，关于**奖励模板**的缺失：目前每条兑换请求自带奖励标题和描述，没有从统一来源引用。这虽然让用户/家长在填写兑换内容时有自由度，但不利于数据的一致性和长期维护。比如可能出现多个名称相似的奖励、或奖励内容不当的问题。**建议（详细见下节）**：考虑引入独立的 Rewards 集合来管理可兑换奖励项，由系统预置或家长自定义，这样兑换请求只需引用 rewardId 并记录消耗积分，既确保一致又方便后续统计和调整。总的来说，Redemptions 结构能基本满足功能，但通过完善兑换流程中的积分事务处理、删除策略和奖励项管理，可以进一步增强数据的健壮性。

## Rewards（奖励集合）

**现状：**目前系统中没有独立的“奖励”集合，关于奖励的资料全部存储在兑换请求 (Redemptions) 文档内，即每次兑换请求都携带了rewardTitle和rewardDescription字段[_[62]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L102-L109)。这意味着奖励内容是由用户提交或选择时确定的，并没有强制与一个固定列表关联。虽然这种方式提供了弹性（家长/学生可填写自定义的奖励名称），但在实际运营中可能带来数据管理的问题。

**问题分析：**缺少统一的奖励数据源会导致以下情况：1）**名称不统一**：相同的奖励可能被不同用户用不同表述提交，多条兑换记录难以聚合分析。例如，若多个孩子都兑换“看电影”作为奖励，可能有人写成“观看电影一次”或“看一场电影”，导致后台统计“兑换了多少次看电影”变得困难。2）**无法预设规则**：运营者无法提前设定一批可供选择的奖励及所需积分，让用户自主选择。如果全部自由填写，孩子可能提出一些不合适或家长无法兑现的奖励，或者家长每次都需商定奖励内容，降低了系统的可控性。3）**调整困难**：假如某类奖励需要调高积分成本（比如发现“看电影”太容易兑换，想从100积分提高到200积分），因为没有集中配置，只能靠通知家长手动改变做法，或者系统无法统一调整已有的兑换项。

**建议方案：**引入 **Rewards** 集合来维护奖励模板列表。该集合中每条记录代表一个可兑换的奖励，字段可包括：title（名称）、description（描述或备注）、pointsCost（所需积分），以及可能的isActive（是否当前可用）或有效期等。可以由系统预置一些常见奖励供选择，也允许家长添加自定义奖励到列表中。用户在发起兑换请求时，只需选择奖励ID，前端即可带出对应标题描述和积分要求，提交后后端只保存引用和快照。为了兼容现有设计，Redemption 文档仍可保存一份冗余的 rewardTitle 和 pointsCost 快照，以防后续改动影响历史记录。但主数据应来自 Rewards 集合以保证一致性。

**实施影响：**增加 Rewards 集合将极大提高兑换相关数据的规范性和可维护性：管理员可以方便地查看有哪些奖励、各自被兑换多少次；修改奖励内容或价格也变得集中且即时生效。同时，前端体验也可优化，例如提供下拉列表或推荐奖励，而不是让用户每次输入文字。短期看，实现这一改动需要调整兑换请求流程和相关界面。但在真实用户试用阶段，这是值得考虑的改进，可以先小规模建立固定奖励清单，观察用户反馈再逐步扩展。

**过渡措施：**如果暂时不方便新增集合，上线初期至少可采取一些措施减少不统一：例如**约束输入**——在提交兑换请求时，引导用户选择几种预定义奖励（可存在前端或配置文件中），同时允许“其他”选项；或者由家长审核时规范化孩子填写的内容。然而从长期看，还是推荐实现独立的 Rewards 数据结构。这样系统的数据模型更清晰：**Rewards****集合**定义了“能兑换什么”，**Redemptions****集合**记录了“谁在何时以多少积分兑换了哪个奖励”。这种模型在真实运营中将更具伸缩性和健壮性。

## 积分与成就（Points & Achievements）

**用户积分字段：**用户文档中维护了一个累计积分值 points，表示该用户当前可支配的积分总数[_[7]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L6-L10)。所有任务完成奖励、家长加分、兑换扣分等都会最终反映到这个字段上。同时，系统设计了 **PointsTransaction****（积分交易）** 集合/记录，用于详细记录每一笔积分增减的过程[_[63]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L242-L250)。PointsTransaction 包含用户ID、关联的每日任务ID（如果适用）、交易类型（earn获取、bonus额外奖励、redemption兑换支出、clawback扣回等）[_[59]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L244-L251)、积分变动数量（正为增加，负为减少）、原因描述，以及审批人、变动前后用户总积分快照等[_[64]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L244-L252)。这相当于一条积分流水日志，用于审计和回滚支持。例如，当用户完成任务获得积分，插入一条earn记录；家长拒绝任务则插入clawback记录表示扣回此前发放的积分；用户兑换奖励则记录redemption类型交易扣减相应积分。

**积分累加与回滚机制：**通过上述设计，系统在架构上已经考虑了积分累加的风险和对策。一方面，User 表中的 points 字段每次变动都有对应的 PointsTransaction，可以**交叉校验**：确保应用逻辑每当更新用户积分时，都同步记录交易，且交易中的 previousTotal/newTotal 与 User表最终值一致。如果出现不一致，说明某些积分变动未记录或并发更新问题。开发者已考虑在操作积分时使用事务会话，保证原子性[_[65]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L122-L130)[_[66]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L798-L806)。另一方面，撤销任务和积分回滚问题也在数据结构上有支持——DailyTask 定义了扩展的字段如 pointsClawback 和 transactionHistory（交易ID列表）以便记录被扣回的积分数和关联的交易[_[67]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L260-L265)。虽然当前 DailyTask 主接口未直接包含这些字段（它们在 DailyTaskWithClawback 扩展接口中[_[67]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L260-L265)），但代码逻辑在家长拒绝任务时，会执行减分并记录交易，然后可以通过查询 PointsTransaction 找到对应任务的扣分记录[_[68]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L876-L884)[_[69]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L878-L886)。因此，从数据层面看，积分的增删都有据可查，避免了悄无声息地篡改用户积分的风险。

**成就与统计字段：**Users 文档中还有表示用户坚持情况和激励的字段：currentStreak 记录当前连续天数[_[2]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L12-L19)（例如已连续几天完成了全部计划任务），以及 medals 对象记录用户是否达成某些里程碑成就[_[70]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L13-L19)。按照注释，青铜/银/金/钻石可能对应7天、14天、30天、60天的连续完成，以此授予不同倍率的积分加成[_[70]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L13-L19)。这些字段能反映用户在长期目标上的进展，并在积分系统中用于计算奖励（PointsRule 中预留了 multipliers.medal 字段以根据勋章调整积分奖励[_[71]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L202-L209)）。当前设计将勋章状态简单地布尔保存，如果用户中断连续天数，推测应用会将相应勋章值重置为 false（失去加成资格）。此设计能够快速判断用户当前享有的奖励倍数，但也意味着无法直接保留曾经获得过勋章的历史记录（除非另有日志）。在早期试用阶段，这并非必要功能，但团队应明确勋章字段的语义——是表示“当前状态拥有该勋章加成”，还是“曾经获得过该成就”。从注释和实现来看，更可能是前者动态值。

**索引与排行榜：**积分和成就相关的查询也得到了索引支持。用户积分用于排行榜，已建立 (points: -1, role: 1) 索引，仅筛选学生用户并按积分降序排列[_[12]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L51-L58)。这使得实时生成积分排行榜成为可能（官方文档称可提速40倍以上[_[13]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md#L22-L25)）。currentStreak 或勋章字段暂未见索引，这些更多是用户个人属性，除非要做例如“寻找连续签到最长的前十名”这样的排行，否则不需要索引。PointsTransaction 集合方面，由于查询一般是针对某用户的全部交易记录，使用 userId 索引即可满足（可以在需要时加上时间排序）。若有按类型统计的需求，也可结合聚合管道或加辅助索引。但考虑到交易集合数据量在试用初期不会太大，现有方案问题不大。

**改进建议：**积分与成就系统在数据结构上已经比较完善，但在上线前有几点值得注意：首先，确保**积分数据一致性**。在试运行时，建议编写脚本核对每个用户的 User.points 是否等于其所有 PointsTransaction.amount 累积之和，这可以验证没有漏记或重复记分的情况。一旦发现差异，应查明原因（可能是某些操作未记录事务或测试手动改过数据）。其次，**扩充交易类型**：目前PointsTransaction涵盖任务、加分、兑换、扣回几类。如果存在游戏时间兑换（用积分换游戏分钟）这种行为，最好也记录到交易中（可以归为 redemption 或单独一种类型），以保证所有积分减少都有追踪。在当前设计中，游戏时间兑换仅记录在 gameTimeExchanges 中，用户积分减少通过更新 User.points 实现，但没有对应交易记录，可能让总积分账目不够完整。建议上线前补充这一环节，将游戏时间兑换也产生一条 redemption 类型的 PointsTransaction（理由：本质也是用积分换取权益的一种）。第三，**成就字段**可以考虑长期优化。例如，如果希望保留用户曾经拿到过某枚勋章的纪念，即使后来失效，也许应该有单独的Achievement日志或字段。这在初期不是必需，但可在数据模型中预留想法。最后，从运营角度出发，可通过分析 PointsTransaction 来调整系统参数，例如某段时间内 bonus 类型占比过高可能意味着家长普遍觉得基础积分不足，需要调节规则等。为方便这样的分析，确保 PointsTransaction 包含足够的元数据（目前有task标题、活动类型、审批备注等[_[72]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L840-L849), 已相当详尽）。综上，积分与成就相关的数据结构考虑了大部分场景，在正式上线前只需在交易记录完整性和一致性校验方面做一次全面检查，即可较有信心地投入使用。

## 游戏时间统计（GameTimeStats 与配置）

**结构组成：**“游戏时间”相关的数据分散在数个集合中，共同实现对用户游戏机（或屏幕）时间的管控与统计。主要包括：**GameTimeExchanges**（游戏时间兑换记录）、**GameSessions**（实际游戏会话记录）、**UserPointsLimits**（用户每日积分/游戏时间限额统计），以及 **GameTimeConfigs**（游戏时间兑换配置）。它们各自扮演不同角色：GameTimeExchanges 记录用户用多少积分兑换了多少分钟的游戏时间；GameSessions 记录用户具体使用了多少分钟游戏（开始/结束时间等）；UserPointsLimits 汇总用户当天已获积分、已用游戏时间等，用于 enforce 限制；GameTimeConfigs 则定义兑换比率和每日免费时长等全局规则。

- **GameTimeExchanges** **集合：** 字段包括用户ID、日期、消耗的积分数 pointsSpent、游戏类型 gameType（普通或教育类游戏）、兑换获得的分钟数 minutesGranted，以及实际在该次兑换中消耗掉的分钟 minutesUsed（如果未全部用完，可以累计到账户）[_[73]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/config/mongodb.ts#L4-L12)。还记录兑换发生时间 createdAt。此集合相当于用户“购买”游戏时间的流水。
- **GameSessions** **集合：** 字段包括用户ID、日期、当次游戏会话实际使用的分钟数 minutesUsed、会话标识或类型 gameSession（可能是游戏名称或会话ID）、开始和结束时间戳[_[74]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/config/mongodb.ts#L14-L21)。每条记录表示一次连续的游戏时间使用情况。它用于详细记录用户何时用了多少时间。
- **UserPointsLimits** **集合：** 这是每天一条的用户统计记录。字段有唯一ID、用户ID、日期，以及一个映射 activityPoints 用于跟踪当日按活动类别/类型累计的积分消耗[_[75]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L228-L236)。同时包含该日用户已获得的总积分 totalDailyPoints、已使用的游戏分钟 gameTimeUsed、当前可用的游戏分钟总数 gameTimeAvailable，以及累积未用的积分 accumulatedPoints（从往日结余下来的积分）[_[76]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L230-L238)。也有 createdAt/updatedAt 记录更新时间。[_[77]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L232-L239)
- **GameTimeConfigs** **集合：**用于存储全局的游戏时间兑换配置。如每天基础免费游戏时间、积分兑换分钟比率、教育类游戏加成、多长游戏时间上限等参数。**需要注意：**类型定义中设计的字段有 baseGameTimeMinutes（每日免费分钟）、pointsToMinutesRatio（每积分可兑换多少分钟）、educationalGameBonus（教育游戏倍率）、dailyGameTimeLimit（每日游戏时间上限）、freeEducationalMinutes（每天免费教育游戏分钟）、weeklyAccumulationLimit（积分累计上限）、dailyPointsLimit（每日可获得积分上限）等[_[78]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L214-L223)。但初始化数据中实际上插入的是每种游戏类型各一条记录，字段包括 gameType（普通/教育）、pointsPerMinute、maxDailyMinutes 等，以及名称和描述[_[79]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L298-L306)[_[80]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L310-L318)。可以看到，这与接口定义不一致：代码接口偏向单条记录管理整体配置，而初始数据采取了按类型分别配置。这种**字段和结构的不一致**必须在上线前解决。

**字段及索引一致性问题：**GameTime配置的不一致是一个严重问题。例如，代码中在计算积分兑换时尝试查询collections.gameTimeConfigs.findOne({ isActive: true })来获取全局配置[_[81]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L44-L52)。按照接口设计，应有一条记录其 isActive:true 且包括所有全局参数。但初始数据插入了两条记录（普通游戏和教育游戏各一）且都标记 isActive: true[_[82]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L300-L308)[_[80]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L310-L318)。这样查询isActive:true可能得到任意一条，甚至两条，导致结果不确定。同时，代码在某些地方用到了 gameTimeConfig.dailyPointsLimit 等字段[_[83]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L42-L50)，但当前记录中并无该字段。类似地，PointsRule 积分规则的接口定义和实际插入也有差异（如接口要求 activity、bonusRules等[_[84]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L192-L200)，但插入的数据使用了name、difficultyMultiplier等[_[22]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L216-L225)）。这些不一致都会造成程序逻辑上的错误或无效查询。**建议：**立即梳理并统一配置类集合的结构。一种方案是采用**单记录全局配置**：将GameTimeConfigs改为始终只有一条当前有效记录，包含接口定义的所有字段；将PointsRules扩充为涵盖activity级别的规则列表（或者仍按类别但字段与代码匹配）。另一方案是接受**多记录配置**：例如GameTimeConfigs维持每种游戏类型一条，但相应代码查询需要调整为 { gameType: 'normal' }或类似方式，并处理两个配置叠加的情况（例如 dailyPointsLimit 等改存于别处）。鉴于当前代码更多是按全局单例配置编写的，倾向于前者，即**修改数据库数据结构以符合代码预期**。具体操作包括：合并现有普通/教育游戏配置为一条记录，字段映射如下：baseGameTimeMinutes=普通游戏免费时长、pointsToMinutesRatio=普通游戏每积分分钟数（取倒数或配置方式调整）、educationalGameBonus=通过普通与教育 pointsPerMinute 比率计算得到（如普通2积分/分钟 vs 教育1.5积分/分钟，可算出教育游戏bonus=1.33），等等。或者简化起见，直接按照设计好的字段赋值，例如每日免费30分钟、每积分兑换多少分钟、教育加成1.x倍等，用合理值填入，然后标记 isActive。这一调整需要在正式使用前完成，否则涉及游戏时间的功能很可能无法正常工作。

**索引设计与性能：**GameTimeExchanges 和 GameSessions 均已建立索引：(userId, date) 用于按照日期查找某用户的兑换或会话记录[_[85]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L198-L205)[_[86]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L220-L228)，这有助于快速统计用户当天兑换了几次、用了多久游戏。Exchanges 还针对 (userId, gameType) 建立索引[_[87]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L207-L215)，方便按用户和游戏类型汇总（比如统计某孩子兑换了多少教育类游戏时间）。GameSessions 还有 (userId, date, minutesUsed) 的索引[_[88]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L228-L232)，可能用于快速计算某用户某天用掉多少分钟。UserPointsLimits 当前索引定义为 { userId: 1, category: 1 }[_[89]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L267-L275)，但 UserPointsLimits 数据结构里并没有直接的category字段——只有 activityPoints 映射可能以活动ID或类型为键。这看起来是一个**索引脚本错误或设计遗留**。如果打算按某活动类型查询用户当天已经累计的积分，则应使用 activityPoints 内嵌字段索引（如MongoDB支持的部分索引），但通常不会这样查询。更有可能，本索引是误将date写成category。为了每日快速获取用户的限额记录，建议改为在 userId+date 上建立唯一索引，确保每个用户每天最多一条记录且查询迅速。总体而言，除了此处，其他索引均合理，数据量在可预见范围内时查询性能充足。

**数据关系与约束：**GameTimeExchanges 与 UserPointsLimits、Users 的积分字段存在紧密关系——当用户兑换游戏时间时，Users.points 应同步减少相应 pointsSpent，UserPointsLimits.gameTimeAvailable 增加对应分钟数，并新增一条GameTimeExchanges记录。当前结构没有直接的参照完整性（如GameTimeExchange并未存 userPointsLimitId），但通过 userId+date 可以关联。当日未用完的兑换分钟应累计进 UserPointsLimits.gameTimeAvailable，次日可能重置（每日限制）。UserPointsLimits.accumulatedPoints 则用于存储未用掉的积分结余，如果有 weeklyAccumulationLimit，则需要每晚将超出部分归零或处理。然而我们尚未在代码中看到执行这些策略的定时逻辑，这属业务实现范畴。就结构而言，应确保 **UserPointsLimits** **每用户每天唯一**，并在新一天开始时创建新记录或重置字段。这可以通过在插入新DailyTask积分时检查当天记录存在与否来实现（代码里确有类似逻辑[_[90]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L46-L55)[_[91]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L68-L76)）。GameSessions 与 Exchanges 的关系也值得考虑：GameSessions记录没存游戏类型，如果需要区分普通/教育游戏的使用时长，必须通过Session时间段去推断所消耗的是哪类分钟（例如优先扣免费教育分钟，再扣兑换分钟等）。这增加了计算复杂度。**建议：**在GameSessions增加一个gameType字段，直接标注该会话使用的是普通游戏时间还是教育游戏时间。这样日后统计“某用户用了多少教育类游戏时间”就不用关联兑换记录推断了。如果一个会话可能混用两类时间（比如先用免费教育分钟，耗尽后用普通分钟），那应该拆分成两条Session记录分别记录各自类型时间。这些细节需要在试用中验证，根据需要调整数据结构或记录方式。

**改进建议汇总：**针对游戏时间相关的数据结构，首要是**统一配置表结构**。务必在上线前解决 GameTimeConfigs 字段不匹配的问题，使代码和数据契合[_[92]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L214-L222)[_[82]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L300-L308)。其次，**修正索引错误**，确认 UserPointsLimits 采用 userId+date 作为查询主键[_[89]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L267-L275)。再次，完善 GameSessions 和 Exchanges 字段，以方便数据分析和限制判定——建议在 GameSessions 增加 gameType 字段，或确保能够从context推断。最后，考虑将游戏时间兑换的积分扣除行为纳入 PointsTransaction 日志，如前文所述，以保持积分账目的完整闭环。整体而言，GameTimeStats 相关的数据结构是这个系统较新的扩展模块，还存在一些不一致和设计不足，但经过上述调整和严谨测试后，应能满足实际使用中的游戏时间管控需求。

## 上线前数据管理建议总览

针对上述各集合的审查结果，我们提出以下总体建议来提高数据结构健壮性，确保系统适合真实用户试用：

1. **同步接口定义与实际数据：**梳理所有集合的模式定义（Types接口）与数据库现状，重点是 PointsRules 和 GameTimeConfigs 等配置类集合的字段不一致问题，以及 Users 缺少 admin 角色、DailyTasks 证据字段重复等问题。在上线前统一数据模型，必要时编写迁移脚本修正现有数据字段。例如，更新 GameTimeConfigs 为单条记录包含所有字段[_[92]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L214-L222)，补充任务模板的 activity 字段等[_[18]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L29-L37)。确保代码和数据库字段一一对应，不出现字段缺失或含义不符的情况。
2. **完善默认值和数据完整性：**检查所有关键字段在创建文档时是否赋值合理。比如新用户注册时应初始化 points=0、currentStreak=0、medals 全 false；管理员账户需补充密码和完整字段[_[6]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L350-L359)；DailyTask 提交完成时应记录预期积分而非简单置0等待审批。通过模拟主要流程来验证数据写入是否完整，如果发现有字段未赋默认值（如某些可选字段导致 undefined），应在模型层或插入时补全。对于依赖双向关系的数据（如 parentId 和 children），强调在逻辑上保证同步更新，或考虑在必要时增加数据库触发器/脚本定期校验一致性。
3. **检查并创建必要索引：**虽然项目已提供索引创建脚本，并涵盖了主要查询模式[_[93]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md#L18-L26)[_[94]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md#L34-L42)，但务必确保这些索引在生产环境数据库中实际创建并生效。建议在部署前执行一次 npm run db:index 或等效操作[_[95]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L50-L58)。然后使用 db.collection.getIndexes() 核验各集合索引状况，尤其是 Users(email)、DailyTasks(userId,date)等关键索引是否存在。对于发现的问题（如 UserPointsLimits 错误的索引键），及时调整索引方案。在性能测试阶段关注慢查询日志，确认索引覆盖了实际使用的查询模式。如有遗漏（例如需要按标签搜索任务，或按currentStreak筛选用户等），酌情补充索引。
4. **实施软删除策略：**梳理全局的删除逻辑，区分真正需要物理删除的情况和可采用软删除的情况。一般而言，为了数据可溯源，用户、任务、兑换记录等重要数据不应轻易物理删除。建议对用户账户和任务模板引入 isDeleted/isArchived 标记，而将 DailyTasks、PointsTransaction 永久保留（通常不需要删除）。兑换请求可用 canceled 状态取代删除。这样可以避免误删数据导致的关联不一致，也方便将来做数据分析（有完整历史）。对于必须物理删除的数据（可能出于法律或隐私要求删除用户），在执行前应备份相关记录，并编写脚本清理依赖（如删除用户时其DailyTasks可选择一并删除或匿名化）。目前提供的删除接口如兑换删除[_[61]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/ad0f407c15df9afb1c4b202bd9af4815b2d64ac2/backend/src/routes/redemptionRoutes.ts#L32-L40)，在正式上线前应重新评估其必要性和影响，做出调整。
5. **数据备份与恢复计划：**在真实用户进入系统前，建立定期的数据库备份机制非常重要[_[96]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L114-L121)。建议至少每天自动备份一次关键集合，备份方案可使用 mongodump 导出[_[96]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L114-L121)，并妥善保存备份文件以防止生产数据意外丢失或损坏。同时准备好恢复流程（mongorestore），并在非生产环境演练过恢复过程，确保备份文件有效。上线前可先手动备份当前测试数据，然后清理测试数据（如演示用户 parent@example.com 等）以启动一个干净的生产库。如果希望保留部分测试数据供演示，可将其标记明显或隔离在不同环境。**注意：**务必使用独立的数据库实例或名称来区分开发/测试与生产环境[_[97]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L144-L148)，避免测试脚本误改生产数据。
6. **初始化数据与配置管理：**充分利用并检查初始数据脚本的结果。当前系统提供了基础任务、积分规则、游戏配置和管理员账号的初始化[_[98]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L340-L349)[_[99]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L396-L401)。建议在上线前再次运行或验证这些初始数据是否在生产库中到位且正确无误（没有重复插入问题，各字段符合最新定义）。初始任务模板可以根据试用反馈做调整增删，但修改时注意保持字段完整性。积分规则和游戏配置如有调整（比如每日积分上限、兑换比率），应通过更新配置集合来完成，而不要硬编码在应用逻辑里，以便日后调整方便。可以考虑加入配置的“版本”或“生效时间”，但在当前试用阶段，一条全局有效配置记录已足够。
7. **数据监控与审核：**上线初期，安排定期审查数据库中的数据状态，及时发现异常。例如，每日检查是否有 DailyTasks 出现反常状态组合（如 status=completed但approvalStatus仍为pending超过合理时间），积分是否有负值或明显异常增长，gameTimeAvailable 是否超出上限，等等。这些检查可以手工通过查询或编写小工具实现。一旦发现数据异常，既要追查原因也要完善相应的数据约束。例如，如果发现某字段经常被留空却本应有值，考虑将其设为必填并在应用层加强校验。
8. **安全与权限检查：**从数据角度确保没有敏感信息明文存储，确认用户密码已散列存储（通过查看Users.password，不应出现明文）[_[100]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/create-demo-users.js#L26-L34)。检查管理类字段（如 isSystemUser）用途，确保普通用户无法滥用。对于角色和关联字段，实现“防越权”还需应用层配合，但也可以考虑在查询时使用些许冗余条件保证安全，比如家长查询DailyTasks时附加userId IN children之类的条件（目前通过代码逻辑已经控制[_[14]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L140-L148)）。这些虽不直接属于结构设计，但和数据健壮性息息相关，在试用阶段尤需注意。

综上所述，在按照以上建议对数据模型进行完善之后，**暑假计划**项目的MongoDB数据结构将更加清晰健壮。尤其是统一模型定义、严格索引管理以及软删除和备份策略，将有效避免真实用户使用时出现的数据不一致、性能瓶颈或不可恢复的误删事故。经过这些调整和最后的验证测试后，相信该系统已经具备了支撑小规模真实用户试运营的可靠数据基础[_[97]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L144-L148)[_[96]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L114-L121)。祝上线顺利！

---

[_[1]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L3-L10) [_[2]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L12-L19) [_[3]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L23-L25) [_[4]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L5-L8) [_[7]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L6-L10) [_[15]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L27-L35) [_[16]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L40-L48) [_[17]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L48-L52) [_[18]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L29-L37) [_[31]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L71-L79) [_[34]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L62-L70) [_[35]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L80-L88) [_[36]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L90-L98) [_[37]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L96-L98) [_[53]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L101-L109) [_[54]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L103-L111) [_[59]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L244-L251) [_[62]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L102-L109) [_[63]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L242-L250) [_[64]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L244-L252) [_[67]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L260-L265) [_[70]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L13-L19) [_[71]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L202-L209) [_[75]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L228-L236) [_[76]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L230-L238) [_[77]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L232-L239) [_[78]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L214-L223) [_[84]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L192-L200) [_[92]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts#L214-L222) index.ts

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/types/index.ts)

[_[5]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L350-L358) [_[6]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L350-L359) [_[19]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L30-L39) [_[22]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L216-L225) [_[23]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L240-L248) [_[24]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L46-L54) [_[79]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L298-L306) [_[80]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L310-L318) [_[82]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L300-L308) [_[98]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L340-L349) [_[99]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js#L396-L401) init.js

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/init.js)

[_[8]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/create-demo-users.js#L70-L74) [_[100]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/create-demo-users.js#L26-L34) create-demo-users.js

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/create-demo-users.js_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/create-demo-users.js)

[_[9]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L31-L39) [_[10]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L43-L51) [_[11]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L59-L64) [_[12]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L51-L58) [_[27]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L72-L76) [_[28]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L80-L88) [_[29]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L88-L93) [_[30]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L96-L101) [_[44]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L109-L117) [_[45]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L117-L125) [_[46]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L125-L133) [_[47]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L157-L161) [_[48]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L133-L140) [_[49]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L141-L149) [_[50]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L149-L153) [_[55]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L170-L175) [_[56]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L170-L178) [_[57]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L178-L184) [_[58]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L186-L194) [_[85]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L198-L205) [_[86]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L220-L228) [_[87]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L207-L215) [_[88]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L228-L232) [_[89]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js#L267-L275) indexes.js

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/indexes.js)

[_[13]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md#L22-L25) [_[93]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md#L18-L26) [_[94]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md#L34-L42) DATABASE_OPTIMIZATION.md

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/DATABASE_OPTIMIZATION.md)

[_[14]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L140-L148) [_[20]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L24-L31) [_[21]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L98-L101) [_[25]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L14-L22) [_[26]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L26-L34) [_[32]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L164-L173) [_[33]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L166-L174) [_[38]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L150-L158) [_[39]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L152-L160) [_[40]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L732-L740) [_[41]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L832-L840) [_[42]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L170-L178) [_[43]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L733-L741) [_[51]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L76-L84) [_[52]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L78-L86) [_[60]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L8-L16) [_[65]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L122-L130) [_[66]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L798-L806) [_[68]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L876-L884) [_[69]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L878-L886) [_[72]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L840-L849) [_[81]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L44-L52) [_[83]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L42-L50) [_[90]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L46-L55) [_[91]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts#L68-L76) dailyTaskController.ts

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/controllers/dailyTaskController.ts)

[_[61]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/ad0f407c15df9afb1c4b202bd9af4815b2d64ac2/backend/src/routes/redemptionRoutes.ts#L32-L40) redemptionRoutes.ts

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/ad0f407c15df9afb1c4b202bd9af4815b2d64ac2/backend/src/routes/redemptionRoutes.ts_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/ad0f407c15df9afb1c4b202bd9af4815b2d64ac2/backend/src/routes/redemptionRoutes.ts)

[_[73]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/config/mongodb.ts#L4-L12) [_[74]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/config/mongodb.ts#L14-L21) mongodb.ts

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/config/mongodb.ts_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/backend/src/config/mongodb.ts)

[_[95]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L50-L58) [_[96]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L114-L121) [_[97]_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md#L144-L148) README.md

[_https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md_](https://github.com/haizhouyuan/SummerVacationPlanning/blob/c54707a748b0a8c6f1f19f8079d58708f57b6806/mongodb/README.md)