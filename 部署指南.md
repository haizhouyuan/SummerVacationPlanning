SummerVacationPlanning 部署指南
第1步：检查本地和服务器环境要求
本地 Windows 环境要求：
•	Node.js 18+ 和 npm：确保本地安装了 Node.js 18 或更高版本，并包含 npm[1]。在命令提示符或 PowerShell 中运行 node -v && npm -v 验证版本。
•	Git: 确保安装了 Git（用于克隆代码仓库）。
•	MongoDB（可选，本地仅用于测试）：生产部署使用服务器上的 MongoDB，本地无需运行 MongoDB 服务。
服务器 Aliyun Linux 环境要求：
•	操作系统更新及基本工具：更新系统软件包，并安装 Git 等常用工具（Git 用于获取代码或后续更新）[2]。例如基于 CentOS 的发行版使用 yum：

 	sudo yum update -y
sudo yum install -y git curl vim
 	(若使用 Ubuntu/Debian，请将上述命令替换为 sudo apt update && sudo apt upgrade -y 和安装所需软件包的 apt install 命令。)
•	Node.js 18+ 和 npm：安装 Node.js 18 LTS。对于 CentOS/RedHat，可通过 NodeSource 仓库自动安装[3]：

 	curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -   # 添加 NodeSource 仓库
sudo yum install -y nodejs                                       # 安装 Node.js 18 和 npm
 	安装完成后运行 node -v && npm -v 验证 Node.js 和 npm 正常可用。
•	Nginx：安装 Nginx 作为前端静态文件的 Web 服务器和反向代理[4]：

 	sudo yum install -y nginx    # CentOS/RedHat 示例；Ubuntu 请使用 apt 安装
sudo systemctl enable nginx  # 配置 Nginx 开机自启
 	安装后执行 nginx -v 确认版本。默认情况下 Nginx 使用用户 nginx（CentOS）或 www-data（Ubuntu）运行。
•	MongoDB 数据库：安装并运行 MongoDB 服务用于持久化存储。以 CentOS 7+/Alibaba Cloud Linux 发行版为例，可按以下步骤安装 MongoDB Community 6.x[5][6]：

 	# 添加 MongoDB YUM 仓库配置
sudo tee /etc/yum.repos.d/mongodb-org-6.0.repo > /dev/null <<EOF 
[mongodb-org-6.0]  
name=MongoDB Repository  
baseurl=https://repo.mongodb.org/yum/redhat/8/mongodb-org/6.0/x86_64/  
gpgcheck=1  
enabled=1  
gpgkey=https://www.mongodb.org/static/pgp/server-6.0.asc  
EOF

# 安装 MongoDB 并启动
sudo yum install -y mongodb-org
sudo systemctl enable --now mongod
 	说明：如果服务器使用 Ubuntu/Debian，请参考 MongoDB 官方文档添加对应的 APT 源并安装。同样安装完成后执行 sudo systemctl enable --now mongod 启动数据库服务。安装完成后，可通过 systemctl status mongod 确认 MongoDB 正在运行，并确保其监听本地端口27017。MongoDB 默认绑定本地 127.0.0.1，不对外开放端口，保证了基本安全。
•	PM2 进程管理器：安装 PM2 用于守护 Node.js 后端进程[7]：

 	sudo npm install -g pm2
pm2 -v    # 验证 PM2 是否安装成功
 	PM2 可确保 Node 应用后台常驻运行、崩溃后自动重启，并可配置开机自启。
•	防火墙和端口：保证服务器防火墙或安全组开放 HTTP 服务端口（80），以及 SSH 端口（22）。如果部署后端服务在非80端口（如 5000），且未使用反向代理同一端口对外，则无需开放5000端口；建议通过 Nginx 代理后端，尽量避免直接暴露应用端口。
第2步：拉取远程代码（master 分支）
在本地 Windows 上获取最新代码。打开 Git Bash 或 PowerShell，执行以下命令克隆代码仓库的 master 分支：
# 将仓库克隆到本地目录 SummerVacationPlanning
git clone -b master https://github.com/haizhouyuan/SummerVacationPlanning.git
cd SummerVacationPlanning
如果仓库默认分支非 master，可省略 -b master 或改为相应分支名称。若本地已存在仓库但需要更新，进入仓库目录执行 git pull origin master 拉取最新代码。
克隆完成后，确认目录结构包含前端 (frontend/) 和后端 (backend/) 子目录，以及各种配置文件（如 README.md、deployment/ 等）。
第3步：本地构建前后端产物
在本地完成前端打包和后端编译，再将构建结果部署到服务器。这避免在性能较低的服务器上进行繁重的构建任务。
1.	安装依赖：进入项目目录后，分别安装前端和后端依赖[8]：
cd frontend && npm install       # 安装前端依赖
cd ../backend && npm install     # 安装后端依赖
cd ..  # 返回仓库根目录
这将根据各自的 package.json 安装所需包。前端使用 React 脚手架，后端为 Node/Express + TypeScript，因此都会安装大量模块（可耐心等待）。
1.	配置前端环境变量（可选）：在前端构建之前，检查 frontend/.env.production 文件配置。该文件用于提供构建时的环境变量，例如 API 地址等。在默认配置中，REACT_APP_API_BASE_URL 已指向示例服务器 IP 和路径[9]。如有需要，请将其中的 REACT_APP_API_URL 或 REACT_APP_API_BASE_URL 修改为实际服务器的域名/IP 和 API 路径。例如，如果将使用域名部署且通过 Nginx 代理 API，可将其设置为：
REACT_APP_API_BASE_URL=http://your-domain.com/api
如果暂时使用服务器IP访问且通过80端口代理后端，则可填入 http://<服务器IP>/api。确保协议和端口正确。这一配置将被编译进前端代码，用于前端请求 API。如未修改，该应用将使用缺省值。
1.	构建前端：进入前端目录执行构建命令[10]：
cd frontend 
npm run build
该命令会打包前端应用，生成静态文件到 frontend/build/ 文件夹（React 默认构建输出在 build/ 目录）[11][12]。构建成功后，frontend/build 下应出现 index.html、static资源目录等文件。此时前端已经准备好部署。
1.	编译后端：进入后端目录执行 TypeScript 编译：
cd ../backend 
npm run build
该命令调用 TypeScript 编译器 tsc 将源码编译为 JavaScript[13]。成功后将在 backend/dist/ 目录下生成编译后的文件（例如 dist/server.js）[14]。确认 backend/dist 文件夹下存在 server.js 以及其它生成的 .js 文件。
1.	准备后端运行文件：后端运行时还需要配置文件和依赖：
2.	确认在后端目录存在示例环境配置文件 .env.example（用于指导生产环境变量设置）。
3.	（可选）如果已有生产 .env 文件，可根据需要修改其中配置；否则稍后将在服务器上新建 .env。
4.	不要将敏感配置上传到Git仓库。确保 .env 列入 .gitignore（仓库中已包含相关规则[15]）。
完成以上步骤后，本地已生成可部署的构建产物： - 前端静态资源：frontend/build 目录 - 后端可执行代码：backend/dist 目录（以及后端的 package.json 等文件）
接下来将把这些文件上传到服务器进行部署。
第4步：上传构建文件到服务器
由于不在服务器上构建，我们将使用 SCP 或 rsync 将本地构建结果拷贝到服务器。以下以 SCP 为例：
1.	准备服务器目录：通过 SSH 连接服务器，创建部署目录（如 /var/www/summer-vacation-planning）用于存放前后端文件：
ssh root@<服务器IP> "mkdir -p /var/www/summer-vacation-planning/{frontend,backend}"
上述命令将在服务器上创建 frontend 和 backend 子目录。您也可以手动登录服务器后逐个执行 mkdir -p 命令创建目录结构。
1.	上传前端构建文件：在本地命令行运行 SCP，将前端打包文件上传到服务器 Nginx 目录。例如：
scp -r ./frontend/build/* root@<服务器IP>:/var/www/summer-vacation-planning/frontend/
这会递归复制本地 frontend/build 目录下的所有文件到服务器的 /var/www/summer-vacation-planning/frontend/ 目录中。复制完成后，可以在服务器上查看该目录，应包含前端的 index.html 和静态资源文件。
1.	上传后端文件：将后端编译输出及必要配置上传服务器：
# 上传后端 dist 编译结果
scp -r ./backend/dist/ root@<服务器IP>:/var/www/summer-vacation-planning/backend/

# 上传后端package.json和锁定文件(如果有)
scp ./backend/package.json root@<服务器IP>:/var/www/summer-vacation-planning/backend/
[ -f ./backend/package-lock.json ] && scp ./backend/package-lock.json root@<服务器IP>:/var/www/summer-vacation-planning/backend/
注意：上面 [ -f ... ] && scp ... 的用法用于判断文件存在再执行上传，可在 Bash 中使用；如果在 PowerShell中执行，可分两步检查后再上传。
确保上传后端的 package.json（及 package-lock.json）文件，这样可以在服务器上安装正确版本的依赖。node_modules 目录不建议直接从 Windows 上传到 Linux，因为其中可能有平台相关的编译文件，应该在服务器上重新安装依赖。
1.	（可选）上传配置文件：如果您在仓库中有专门的部署配置文件（例如 PM2 的 ecosystem.config.js 或 Nginx 配置范例），也可以一并上传：
 	# 上传 PM2 配置文件（如果需要使用）
scp ./deployment/ecosystem.config.js root@<服务器IP>:/var/www/summer-vacation-planning/

# 上传示例 Nginx 配置（稍后仍需根据实际调整）
scp ./deployment/nginx.conf root@<服务器IP>:/var/www/summer-vacation-planning/
 	这些文件可作为参考。在服务器部署时，我们也会直接按照需要配置 Nginx 和使用 PM2，上传与否皆可。
完成上述步骤后，服务器上 /var/www/summer-vacation-planning 目录应当包含两个子目录： - frontend/：里面是构建好的前端静态文件。 - backend/：里面有后端 dist/ 目录和后端的 package.json 等文件。
第5步：在服务器上部署应用
现在在服务器上完成安装依赖、配置环境变量，并运行前后端服务。
5.1 安装后端依赖
通过 SSH 登录服务器，进入后端目录并安装生产依赖：
cd /var/www/summer-vacation-planning/backend
sudo npm install --production
使用 --production 参数确保只安装生产环境需要的依赖（忽略开发依赖），以节省空间和避免不必要的软件。安装过程中请耐心等待。完成后可以看到生成 node_modules 目录，其中包含 Express、MongoDB 驱动等后端运行所需的模块。
5.2 配置后端环境变量
在后端目录下新建实际运行所需的环境配置文件 .env（可基于之前上传的 .env.example 模板）。执行：
cp .env.example .env  # 如果 .env.example 存在的话
然后使用文本编辑器编辑 .env 文件（例如使用 nano 或 vim）：
sudo nano .env
根据实际情况填入配置项，主要包括：服务器环境、端口、数据库连接、密钥等。[16][17]
.env 文件关键配置示例：
# 运行模式
NODE_ENV=production
PORT=5000

# 数据库配置
MONGODB_URI=mongodb://127.0.0.1:27017/summer_vacation_planning

# 安全配置
JWT_SECRET=请填写一安全的随机字符串
CORS_ORIGIN=http://<你的服务器IP或域名>

# （可选）Firebase 存储配置，如不使用可留空或删除
FIREBASE_PROJECT_ID=your-firebase-project-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...YOUR KEY...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxx@your-project.iam.gserviceaccount.com
FIREBASE_STORAGE_BUCKET=your-project.appspot.com

# 其他配置保持默认或按需修改
RATE_LIMIT_WINDOW_MS=900000       # 15分钟窗口
RATE_LIMIT_MAX_REQUESTS=100       # 每IP最大请求数
LOG_LEVEL=info                    # 日志级别
请根据需要调整：
•	MONGODB_URI：指定 MongoDB 连接字符串，格式为 mongodb://<主机>:27017/<数据库名>[18]。如果 MongoDB 与后端部署在同一台服务器且不需要用户名密码，可以使用 mongodb://127.0.0.1:27017/your_db_name。上述示例中使用了数据库名 summer_vacation_planning，可自行更换。确保该数据库已启动，且后端能够连接（MongoDB 默认无需凭据即可连接本地数据库，可考虑自行设置用户名/密码提高安全性）。
•	PORT：后端服务监听端口，设置为例如 5000。在生产中我们通过 Nginx 转发80端口请求到该端口。如果您倾向使用其他端口，请同步调整 Nginx 配置中的转发端口以及前端的 API 地址配置。
•	JWT_SECRET：JWT签名密钥，请填入足够复杂的随机字符串以保证安全。[19]
•	CORS_ORIGIN：设置为前端地址。例如没有域名时可设为 http://<服务器IP>，有域名则填入 https://yourdomain.com 等。确保与前端实际访问来源一致，否则浏览器可能因跨域限制拒绝请求。
•	Firebase 配置：如果应用中仍使用 Firebase（例如云存储用于保存上传的图片/视频），需要提供相应的凭证。在完全使用本地后端+数据库替代 Firebase 的情况下，可不配置这些项并确保代码不会调用相关 Firebase 服务。若保留 Firebase Storage 用于文件存储，请填写项目 ID、客户端邮箱、私钥等（或在 .env 中提供 Admin SDK 密钥文件路径），以便后端能够访问 Firebase 服务。
编辑完成后保存并退出。切记不要泄露 .env 内容，该文件包含敏感信息，应仅存储在服务器安全的位置。
5.3 构建和优化数据库
由于我们已在本地编译后端 TypeScript，服务器上可以直接运行无需重新编译。如果刚才由于配置环境变量的需要而修改/新增了后端代码（通常不需要），可以重新执行一次构建命令确保 dist 更新：
# 如无代码改动可跳过此步
npm run build
接着，运行数据库索引优化脚本（如果有），以在MongoDB中创建必要的索引，提高查询性能。仓库提供了 npm run db:optimize 脚本可一次性创建索引[20][21]：
npm run db:optimize
该脚本会连接 MongoDB 并创建后台需要的索引（如用户集合的唯一索引等）。请确保 .env 中的 MONGODB_URI 正确且 MongoDB 服务正在运行，否则此步骤会报错。如果不确定，可以先跳过，待应用启动后再手动检查数据库状态。
5.4 启动后端服务（使用 PM2）
使用 PM2 将后端 Node.js 服务以守护进程方式启动。可选择直接指定脚本启动，或使用 PM2 配置文件。
方法A：直接启动：在后端目录下执行：
pm2 start dist/server.js --name "summer-vacation-api"
此命令通过 PM2 启动编译后的后端应用[22]。--name 为该进程指定一个易识别的名称（如 summer-vacation-api），方便管理。启动后可运行 pm2 list 或 pm2 status 查看进程状态，确认应用已在监听设定端口。
方法B：使用配置文件启动（可选）：如果之前上传了 ecosystem.config.js（PM2 配置），可通过以下命令启动：
pm2 start /var/www/summer-vacation-planning/ecosystem.config.js --env production
PM2 将按配置文件中定义的参数运行应用（例如 cluster模式启动多个实例等）[23][24]。请确保配置文件中的路径、端口等与实际一致（仓库默认配置使用 dist/server.js、端口5000、cluster模式2进程等[25]）。
无论采用哪种方式启动，建议在 PM2 中保存当前运行的进程列表并设置开机自启[26]：
pm2 save                  # 保存当前进程列表
pm2 startup               # 生成开机自启脚本
sudo env PATH=$PATH pm2 startup -u root --hp /root   # 按输出提示执行（如果需要sudo）
上述 pm2 save 会将当前运行的应用进程记录下来，pm2 startup 则生成系统启动 PM2 的配置（在某些系统需要附加参数指定用户）。执行后，可在重启服务器后用 pm2 list 验证应用是否自动启动。注意：若使用非 root 用户运行 PM2，请将上述命令的 -u root --hp /root 替换为相应用户名及主目录路径。
5.5 配置 Nginx 前端服务与反向代理
配置 Nginx 来提供前端静态页面，并将特定请求转发给后端 API 服务。这样浏览器访问统一的域名/IP即可获得前端页面和后端数据。
1.	创建 Nginx 配置文件：在服务器上新建 Nginx 站点配置文件，例如：
sudo nano /etc/nginx/conf.d/summer-vacation.conf
(如果是 Ubuntu，可在 /etc/nginx/sites-available/ 下创建并 symlink 到 sites-enabled/[27]。CentOS 通常使用 /etc/nginx/conf.d/ 目录直接包含配置文件。)
填入以下配置，并根据注释修改相应值：
server {
    listen       80;
    server_name  你的域名或服务器IP;

    # 前端静态文件服务
    root   /var/www/summer-vacation-planning/frontend/build;
    index  index.html index.htm;

    # 前端路由：如请求的文件不存在，则始终返回 index.html (SPA前端路由)[28]
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 请求代理[29]
    location /api {
        proxy_pass http://127.0.0.1:5000;   # 转发到后端应用端口
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # 上传文件访问代理：转发/uploads请求到后端[30]
    location /uploads {
        proxy_pass http://127.0.0.1:5000;
    }

    # 健康检查接口代理（可选）[31]
    location /health {
        proxy_pass http://127.0.0.1:5000/health;
    }

    # 文件上传大小限制（根据需求调整）[32]
    client_max_body_size 100M;
}
配置说明：
- listen 80; 配置监听80端口的 HTTP 服务。
- server_name 请改为实际域名或服务器公网IP[33]。如果暂未绑定域名，可填服务器IP地址（如 47.120.74.212），这样浏览器以IP访问时可匹配到该配置。
- root 和 index 指定静态文件所在目录和默认文件名。[28]我们将前端构建文件放在 /var/www/summer-vacation-planning/frontend/build，确保路径正确无误。
- 前端路由：location / 配置使用 try_files 尝试定位请求的静态资源文件，如果不存在则返回 index.html[28]。这保证了React单页应用的路由刷新或直达子页面时，不会因文件不存在而返回404，而是始终由前端路由接管。
- API代理：location /api 将所有以 /api 开头的请求转发到后端 Node.js 服务[29]。proxy_pass 指向本机 5000 端口（即后端监听端口）。其他 proxy_set_header 用于在转发请求时保持原始的 Host 和客户端IP等信息，方便后端日志和安全控制。确保此段的端口与前面 .env 中后端 PORT 相对应。
- 文件上传代理：由于后端开放了 /uploads 静态目录用于提供上传的文件[30]，这里增加 location /uploads 将这些请求同样代理给后端。这样前端访问 /uploads/xxx.jpg 时，由后端提供文件内容。如果您的前端直接通过后端 API 获取文件或使用云存储，则可根据情况调整。
- 健康检查：/health 路由用于快速健康检查应用状态[34]。配置转发使您可以通过 http://服务器/health 直接获取后端运行状态（返回 JSON 包含 "status": "OK"）。
- 上传大小限制：增加 client_max_body_size 100M; 设置允许上传请求的最大主体为100MB[32]。根据业务需要调整此值，避免用户上传较大文件时被Nginx拦截（默认仅1MB）。如涉及视频上传等可适当提高限制。
1.	启用配置并重启 Nginx：保存配置文件后，执行以下命令生效配置：
sudo nginx -t && sudo systemctl reload nginx
nginx -t 会测试配置语法，应当输出 syntax is ok 和 test is successful[35][36]。然后 reload 平滑加载新配置。如果使用 Ubuntu 的 sites-available/sites-enabled 机制，还需执行 sudo ln -s /etc/nginx/sites-available/summer-vacation.conf /etc/nginx/sites-enabled/ 建立软链接[27]，再重启 Nginx 生效。
执行 sudo systemctl enable nginx 确保 Nginx 在服务器重启后自动启动（如果之前未设置的话）。
1.	设置文件权限（如有必要）：确保前端部署目录的文件可被 Nginx 进程读取。如果 Nginx 以 nginx 用户运行，而上传的文件属主属组是 root，可能需要调整权限。可以将整个前端构建目录授予 Nginx 用户所有权，例如 CentOS 下执行：
sudo chown -R nginx:nginx /var/www/summer-vacation-planning/frontend/build
对于Ubuntu默认的 www-data 用户，则相应替换为 chown -R www-data:www-data。注意：只需对静态文件目录调整权限。后端代码不在 Nginx 服务路径下，无需修改。一般来说，只要文件对其他用户可读，Nginx 也能读取，但设置属主有助于避免潜在权限问题[37]。
配置完成后，Nginx 即扮演两个角色：一是直接服务前端静态页面，二是将API请求代理给后端服务。现在，通过服务器IP或域名即可访问应用。例如，在本地浏览器打开 http://<服务器IP> 应该可以看到前端应用界面，并正常与后端交互。[38]若无法访问，请检查安全组/防火墙是否放行80端口，或使用 curl -I http://127.0.0.1 在服务器上测试 Nginx 是否有响应。
第6步：启动和停止服务的方法
部署完成后，需要掌握如何启动、停止和管理服务进程：
•	启动后端服务：如果尚未启动 PM2 进程，可按照前述步骤执行 pm2 start dist/server.js --name "summer-vacation-api" 启动后端。[22]服务启动后，后端会在 .env 指定端口监听（如5000）。可通过健康检查验证：

 	curl http://127.0.0.1:5000/health    # 在服务器上本地请求后端健康检查
 	若返回 JSON 包含 "status": "OK" 则表示后端正常运行[39]。
•	停止后端服务：使用 PM2 管理时，可执行：

 	pm2 stop summer-vacation-api
 	这将停止名称为 summer-vacation-api 的应用。如果以后不再需要保持进程列表，亦可使用 pm2 delete summer-vacation-api 将其从 PM2 中移除。
•	重启后端服务：当有代码更新或配置修改，需要重启生效时，可执行：

 	pm2 restart summer-vacation-api
 	PM2 会平滑重启应用。也可用 pm2 reload <name> 等命令，根据需要重载。
•	查看运行状态和日志：
•	运行 pm2 list 或 pm2 status 查看所有 PM2 管理的进程状态（在线/停止等）[36]。
•	运行 pm2 logs summer-vacation-api --lines 100 查看该应用最近100行日志输出，了解运行状况或错误。可按 Ctrl+C 退出日志流。
•	运行 pm2 monit 打开交互式监控界面，查看 CPU、内存占用等实时指标[36]。
•	启动/停止 Nginx：Nginx 作为系统服务通过 systemd 管理。常用命令：

 	sudo systemctl restart nginx   # 重启Nginx（读取新配置）
sudo systemctl stop nginx      # 停止Nginx服务
sudo systemctl start nginx     # 启动Nginx服务
 	注意：修改 Nginx 配置后应先 nginx -t 测试，再执行 reload/restart 应用更改。停止 Nginx 将使所有网页无法访问，谨慎操作。
•	启动/停止 MongoDB：MongoDB同样由 systemd 管理：

 	sudo systemctl stop mongod     # 停止MongoDB
sudo systemctl start mongod    # 启动MongoDB
sudo systemctl restart mongod  # 重启MongoDB
 	一般MongoDB会一直运行，不需要频繁启停。可用 systemctl status mongod 检查其状态。
一旦 PM2 配置了开机自启并保存进程列表，服务器重启后会自动启动后端服务[40]；Nginx 和 MongoDB 也在 enable 后会开机启动。因此通常不需要每次手动启动所有组件。但在部署或维护过程中，需要熟悉上述命令以便手动控制服务状态。
第7步：MongoDB 数据库配置与注意事项
•	连接配置：后端通过环境变量 MONGODB_URI 来读取数据库连接字符串[41]。请确保 .env 中该变量填写正确。如数据库在本机且无鉴权，典型字符串格式为：

 	MONGODB_URI=mongodb://127.0.0.1:27017/summer_vacation_planning
 	这表示连接到 localhost 的27017端口，数据库名为 summer_vacation_planning。第一次连接时如果数据库不存在，会自动创建。同样，如果您配置了 MongoDB 用户和密码，则需按 mongodb://user:pass@host:27017/dbname 格式填写。重要：MongoDB 默认无身份认证且仅允许本地主机连接，在生产环境中这一般是安全的（前提是数据库端口未对外开放）。如需开放数据库访问，请务必配置用户密码和相应权限。
•	MongoDB 服务状态：部署前请确认 MongoDB 服务已启动并在运行[6]。可在服务器上执行 mongo --eval "db.stats()" （需安装 Mongo Shell 客户端）或通过 systemctl status mongod 检查。如果 MongoDB 未运行，后端启动时将无法连接，导致错误。遇到连接问题请检查：
•	MongoDB 是否已启动并监听 27017 端口。
•	.env 中主机是否写成 localhost/127.0.0.1（不要写成 0.0.0.0 或公共IP，除非开启了远程访问）。
•	防火墙是否阻挡了 MongoDB（如果只本地访问，可不开放27017端口）。
•	初始化与数据导入：如有初始数据需要导入（比如默认的任务列表等），可以编写脚本连接数据库插入初始记录。项目仓库中 mongodb/ 目录可能包含初始化脚本或索引定义[42]。例如 mongodb/init.js、mongodb/indexes.js 等。如果存在，可考虑在首次部署时运行这些脚本（或者确保 npm run db:optimize 已经创建了索引[20]）。一般情况下，应用在第一次运行时会在数据库中创建必要的数据集合。
•	数据库备份：正式上线后，务必制定 MongoDB 数据的备份策略。例如使用 mongodump 定期导出数据，防止意外数据丢失。这虽然不属于部署流程的一部分，但对生产环境极其重要。
•	性能调整：在2GB内存的服务器上，MongoDB在默认配置下应该可以正常运行小规模应用。但如果数据量增大，注意监控内存占用。MongoDB的 WiredTiger 存储引擎默认会使用最多一半内存作为缓存。如果需要，可以在配置文件 (/etc/mongod.conf) 中调整 storage.wiredTiger.engineConfig.cacheSizeGB 来限制缓存大小，避免与应用争夺内存。但切勿将其设置过低影响性能。初期可以不修改，观察运行情况再优化。
第8步：生产环境部署注意事项
完成部署后，还需考虑以下生产环境的注意事项，以保证服务稳定、安全运行：
•	端口和安全组：确认云服务器安全组放行了用户需要访问的端口。通常只需开放80（HTTP）以及443（HTTPS，若启用），SSH默认22端口。应用后端监听的5000端口无需对外开放（通过Nginx代理即可），数据库27017端口也不应对外开放。可以通过云控制台和 sudo netstat -tulpn | grep LISTEN 检查端口开放情况，避免不必要的端口暴露。[43]
•	启用HTTPS（未来规划）：目前我们使用HTTP部署，强烈建议在生产环境尽快配置HTTPS确保数据传输安全。可使用免费工具如 Certbot 获取SSL证书并自动配置 Nginx[44]。简单步骤包括：
•	注册域名并解析到服务器IP。
•	使用 certbot --nginx -d yourdomain.com 一键申请并配置证书[45]。
•	Certbot 会自动修改 Nginx 配置添加443端口的 server 块和证书路径，并设置HTTP自动重定向。启用后请在 .env 中将 CORS_ORIGIN 等改为 https://yourdomain.com。
•	配置证书自动续签（Certbot 通常默认添加了续约计划，可通过 sudo crontab -l 查看是否存在定期certbot renew任务）。
部署初期如暂不具备HTTPS条件，应告知用户其连接是不加密的，并尽早规划升级。
•	权限与用户管理：出于安全考虑，不建议长期以 root 用户运行应用服务。可以创建专门的系统用户运行 Node 应用，并相应修改文件属主和 PM2 的配置（例如上述 pm2 startup 使用具体用户）。同时，确保 .env 等敏感配置文件权限设为只有管理员可读写。对上传的文件目录，也可根据需要设置合适的权限掩码，防止敏感内容通过错误配置被下载。
•	日志管理：Nginx 默认会将访问日志和错误日志分别写入 /var/log/nginx/access.log 和 /var/log/nginx/error.log。Node 应用的日志则由 PM2 接管（可以通过 pm2 logs 实时查看，也可以在 ~/.pm2/logs/ 或 PM2配置中定义路径）[24][46]。建议定期检查日志，设置日志轮转（logrotate）防止日志占满磁盘。启用 PM2 的日志压缩或定期清理旧日志也是必要的维护工作之一。
•	监控和告警：在生产环境应监控应用的运行状态。可以使用 PM2 自带的监控 (pm2 monit) 查看资源使用[36]。对于长期运行，可以考虑搭配 NodePing、UptimeRobot 等服务监测站点可用性，或者设置服务器内部的 cron 定期执行 curl /health 做简单检查。MongoDB 提供 db.stats() 等命令可以获取数据库状态[47]。及时发现高负载、错误或异常情况，防患于未然。
•	性能和扩展：当前配置在2核2G服务器上运行，如果用户量增加，需关注性能瓶颈。使用 PM2 cluster 模式已经可以利用多核[48]。必要时，可以考虑：
•	前端优化：启用Nginx对静态资源的长缓存（在配置中已添加一年缓存的示例[49]），并开启 gzip 或 brotli 压缩（通过在 http 块中添加 gzip on; 等指令）。
•	后端扩展：如果单台服务器不足以支撑，可考虑水平扩展——将前端部署到CDN或多台服务器，用负载均衡分发请求到多个后端实例。MongoDB也可以迁移到托管服务或集群模式。
•	数据库优化：确保创建了必要的索引（首次部署已通过脚本创建[20]）。随着数据增长，可适当优化查询、清理冗余数据等。
•	安全设置：除上述HTTPS，加固服务器本身的安全：
•	禁止密码方式登录SSH，改用密钥认证，避免暴力破解。
•	定期更新系统和软件补丁，特别是Node.js、MongoDB等的安全更新。
•	使用防火墙(UFW/iptables)限制非必要的出入流量。
•	如果应用面对公众用户，注意防范常见Web安全风险。在代码中已经实现了JWT认证、CORS控制、防注入等措施[50][51]，部署层面仍需留意例如 Nginx 是否设置了适当的HTTP头、防止泄漏软件版本信息等（可以配置 server_tokens off; 隐藏Nginx版本）。
•	应用维护：部署完成后，可参考以下清单验证应用功能正常：[52]
•	前端页面能否正确加载，路由跳转是否正常（刷新深层链接不会404）。
•	用户注册、登录流程是否通畅。
•	任务创建、编辑、完成提交等功能是否正常。
•	父母端的审批、查看是否正常。
•	文件上传：特别地，上传图片/视频功能是否可用，上传的文件能否通过应用访问[53]。
•	积分和排行榜是否按预期工作。
一旦全部验证通过，这个“暑假规划”应用就已经在生产服务器上稳定运行了 🎉。[54]接下来，保持定期备份数据库、更新依赖、监控日志，即可支持应用长期稳定地服务用户。如后续需要更新代码，可以在本地测试通过后，重复步骤2-5上传新构建，并使用 PM2 重启以应用更新，整个流程尽量做到无停机发布。
________________________________________
[1] [8] [10] [11] [12] [42] [50] [51] [54] README.md
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/README.md
[2] [3] [4] [5] [6] [7] [14] [16] [18] [22] [26] [37] [38] [39] [40] DeploymentChatgpt.md
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/DeploymentChatgpt.md
[9] .env.production
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/frontend/.env.production
[13] package.json
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/backend/package.json
[15] [19] ENV_SETUP_GUIDE.md
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/ENV_SETUP_GUIDE.md
[17] [20] [21] [27] [28] [29] [31] [32] [33] [35] [36] [41] [43] [44] [45] [46] [47] [49] [52] [53] PRODUCTION_DEPLOYMENT_GUIDE.md
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/PRODUCTION_DEPLOYMENT_GUIDE.md
[23] [24] [25] [48] ecosystem.config.js
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/ecosystem.config.js
[30] [34] app.ts
https://github.com/haizhouyuan/SummerVacationPlanning/blob/d4ae1436ce1d2645a5b66a6eb3f294a6d33a53c0/backend/src/app.ts
