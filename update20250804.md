明白了，我将梳理SummerVacationPlanning仓库的现状，并结合暑期积分奖励计划的背景，明确两个核心功能（任务规划与记录/家长确认、积分奖励机制平衡）的需求与优先级，最后生成可直接交付给claudecode执行的ToDo列表。稍后我会将分析结果呈现给你。


# 暑期积分奖励计划 功能分析与开发计划

## 现有功能与代码结构分析

**项目概览**：仓库`haizhouyuan/SummerVacationPlanning`采用前后端分离架构，前端使用React + TypeScript，后端使用Node.js (Express) + MongoDB。代码组织清晰，前端有`components/`、`pages/`等目录，后端划分了`controllers/`、`routes/`、`middleware/`等模块。系统针对**家长**和**学生**两个角色实现了暑期任务规划和积分奖励的功能。

### 1. 任务规划与记录功能

* **任务创建与库管理**：后端定义了\*\*任务 (Task)\*\*实体，包含标题、描述、类别、难度、预计时长等属性。每个任务还可指明是否需要完成证据（如照片/视频）。家长或学生可以通过API创建新任务（`POST /tasks`）并存入任务库。任务类别如运动、阅读、家务、学习等，有固定枚举；难度分为`easy/medium/hard`。这些字段为后续积分评估提供依据。

* **任务计划 (日程) 与打卡**：学生可以从任务库选择任务并规划到具体日期，形成\*\*每日任务 (DailyTask)\*\*记录。创建DailyTask时需要提供任务ID和日期，系统将任务记录状态初始化为`planned`，积分初始为0，且标记`approvalStatus: 'pending'`表示需要家长确认。DailyTask还支持记录计划时间段、提醒时间、优先级和备注等信息。一个任务同一天只能计划一次。

  学生在完成任务后，通过“打卡”功能将该DailyTask的状态更新为`completed`，可提交文本心得和图片/视频等证明（后端接受`evidenceText`和`evidenceMedia`字段）。系统在接收到打卡请求时，会根据任务属性自动计算此次完成应得的积分，将其写入DailyTask的`pointsEarned`。例如，代码中当状态变为completed时，获取对应Task对象，组装其预计时长、文本字数、难度等数据，调用`calculateConfigurablePoints`计算积分。若任务题目包含关键词（如“日记”、“数学”、“奥数”等），会匹配到特定的活动类型，以应用相应的积分规则。计算结果包括基础分和奖励分，最终总分写入pointsEarned。同时记录完成时间completedAt，并将任务状态标记为完成。

* **家长确认机制**：所有DailyTask在学生完成后默认处于“待家长审批”状态（approvalStatus初始为pending）。系统实现了家长审批的接口，家长登录后可查看子女**待审核**的任务列表，内容包括任务详情、孩子提交的文字和媒体证据、孩子备注等。只有标记需要证据的任务且已完成的，会出现在待审批列表中。家长可选择**通过**或**拒绝**：

  * **通过审批**：调用`PUT /dailyTasks/{id}/approve`接口（或相应路由），附带`action: 'approve'`，可选填写`approvalNotes`（家长评语）和`bonusPoints`（额外奖励积分）。后端接收后，将该DailyTask的approvalStatus设为`approved`，记录approvedBy和时间。若家长给了额外积分，则在原有pointsEarned基础上增加，并增加到学生的总积分账户。这样孩子完成任务的积分奖励在家长确认后可能提高（比如家长认为完成得特别好，追加奖励）。

  * **拒绝审批**：家长可退回任务要求重做，调用时`action: 'reject'`并可附理由。后端将该任务标记为`rejected`，同时可以把DailyTask状态从已完成改回`in_progress`表示未完成。**目前实现上**，拒绝时只是更新状态，没有自动扣除之前给予的积分（孩子在打卡完成时已拿到基础积分）。这一点在后续的差距分析中会提到，需要改进以保证未通过的任务不给积分。

  所有审批操作也允许家长留下文字反馈（approvalNotes)，系统在DailyTask里保存审批意见和审批时间等。学生端可以看到任务从“待确认”变为“已通过”或“已拒绝”，并查看家长的备注和加减分情况。

* **记录和统计**：系统把任务、每日任务、用户等数据保存在MongoDB中，确保数据持久化。每次任务计划、完成、审批都会更新数据库相应集合（tasks、dailyTasks、users等）。另外还有一些统计功能，比如计算某周的任务完成率、总积分等（如`getWeeklyStats`/`getWeeklySchedule`提供每周任务情况）。这些有助于家长查看孩子整体的暑期任务完成进度。项目还实现了**成就和连续天数**逻辑，比如计算连续完成任务天数，从而授予铜/银/金/钻石徽章并提供积分倍数奖励（后端在每次任务完成时调用`checkAndUpdateStreak`检查并更新User的currentStreak和medals字段）。

### 2. 积分奖励机制的平衡

* **积分与难度挂钩**：系统通过\*\*积分规则 (PointsRule)\*\*来灵活控制不同任务类别、活动和难度对应的积分值。展示了在计算积分时应用难度系数的逻辑：如果积分规则为某类别/活动定义了难度倍率，则任务基础分+奖励分之和会乘以该倍率。例如，可配置easy=1.0、medium=1.2、hard=1.5等，代码会取出pointsRule.multipliers.difficulty对应难度的倍数来调整总分。此外还支持根据任务质量（quality）和孩子的勋章成就（medal）来乘以额外倍率。勋章对应孩子连续完成任务的天数，铜银金钻各提高10%-40%不等。这些机制确保难度高、持续表现好的情况能获得更多积分，激励孩子挑战自我。

* **每日积分上限**：为防止孩子在单日内通过堆积简单任务获取过多积分，系统引入**每日积分限制**概念。PointsRule规则中可以为特定活动设置`dailyLimit`。后端在任务完成打卡时，会在UserPointsLimit集合中记录当天该活动已获得的积分总和。有一个专门的API(`checkDailyPointsLimit`)用来在加分前检查是否超出上限：如果某活动当日积分将超标，就返回错误并告知上限和当前已得分。在当前实现中，打卡完成时**并未阻止**超限积分的累积，而是简单累计；但这个检查API可供前端在任务提交前调用，从而提醒用户或阻止该任务获取积分（见下文差距部分）。另外，UserPointsLimit还记录`totalDailyPoints`用于跟踪每日总积分。虽然代码未明确设定一个全局每日上限N分，但有了totalDailyPoints字段，后续可以轻松增加此规则。

* **每周积分积累与兑换**：系统鼓励孩子及时将积分兑换为奖励而非无限累积。**GameTimeConfig**配置中定义了`weeklyAccumulationLimit`（每周积累上限）等参数。UserPointsLimit文档里也有`accumulatedPoints`字段用于记录未使用的剩余积分。如果孩子某天没用完积分可以结转，但不应无限滚存。当前实现没有自动清零或强制限制，但提供了结构支持，方便以后实现每周最多累积多少积分的策略（例如超过上限就提醒或清空）。

* **积分兑换游戏时间**：**游戏时间**是主要的兑换奖励形式。根据项目背景，“1积分=5分钟游戏时间”，每天基础免费游戏时间30分钟，另外鼓励教育类游戏（1积分兑换10分钟且每天前20分钟免费）。代码中维护了这些兑换比例常量（EXCHANGE\_RATES），并实现了兑换流程：

  学生可以调用`POST /rewards/game-time/exchange`提交要花费的积分数和游戏类型（普通或教育）。后端首先检查用户积分是否足够；若是教育类游戏且当日尚有“免费20分钟”额度，则在兑换时先赠送免费分钟且不扣积分（比如孩子兑换10分钟教育游戏时间，如果当天还未用免费额度，则直接送10分钟且积分开销为0）。否则，按比例计算应授予的分钟数（普通游戏每1分兑换5分钟，教育游戏1分10分钟）。然后系统创建一条**兑换记录**(gameTimeExchange)，内容包括用了多少积分换了多少分钟。用户账户的总积分也即时扣减相应分值。

  兑换后，学生每天可以累计的游戏时间＝基础30分钟＋兑换所得分钟。系统提供`GET /rewards/game-time/today`接口返回当天已兑换和使用的游戏时间统计。当孩子要**开始玩**时，调用`POST /rewards/game-time/use`告知系统将消费多少分钟。后端会验证请求的分钟数不超过可用余额（base＋已兑换－已用）；若足够，则记录一次游戏会话（gameSession）并按先用基础时间再用兑换时间的顺序扣减可用分钟。这样确保孩子不能超时游戏，且用掉的兑换分钟在数据库标记为已使用。

* **积分兑换实物/特殊奖励**：除了游戏时间，家长还能设定**实物或体验奖励**，如攒100分换一款新游戏，150分换一次真人赛车体验等。代码里已经写定了一组**特殊奖励清单**：每项有唯一id、名称描述和所需积分。当调用`GET /rewards/special`时，后端返回这些奖励项并注明当前用户是否有足够积分可以兑换（available字段）。例如显示“购买新游戏”需要100分，如果孩子积分>=100则available为真。这些规则直接来源于“暑期计划”策划案，例如100分奖新品游戏、200分奖一次家庭短途游等，都已涵盖。

  当前实现主要是**列出**可兑换奖励，并未提供直接兑换操作接口。然而，从代码来看有一套**积分兑换申请**机制（Redemption）：在旧的控制器文件中定义了`createRedemption`、`updateRedemptionStatus`等函数，用于提交兑换请求和由家长审批。逻辑是：当孩子提出兑换申请（比如想用100分换奖励），系统检查积分是否足够然后创建一条Redemption记录状态为pending，积分先不扣或暂扣；家长审核通过时才真正扣除积分并标记兑换完成。这套机制保证了高价值兑换需要家长确认。根据README，家长端有“积分兑换管理/审批”功能。因此，可以推测前端已有或计划有界面让孩子发起兑换请求、家长批准。总之，**积分兑换规则**在系统中是有支持的，包括即时兑换游戏时间和申请兑换实体奖励两种形式。家长在应用中可以随时查看孩子当前积分余额以及可兑换的奖励项目。

## 当前功能与预期需求的差距梳理

现有系统已经较全面地覆盖了“暑期积分奖励计划”的核心需求，但仍有一些细节与预期要求存在差距，需要加以改进或确认：

* **家长对任务规划的介入**：从需求看，家长可能也会参与任务管理（比如给孩子指定任务）。目前任务的创建和日程安排主要由登录用户自己进行，代码中`createDailyTask`默认将任务归属当前用户。这意味着**学生**可以给自己安排任务，但**家长账户**无法直接帮孩子创建日程（除非切换成孩子账户或者系统本身支持多用户关联）。鉴于应用场景是家长和孩子共同制定计划，系统需支持家长为孩子添加任务计划。这需要在后端开放相应权限：当登录角色为家长时，允许指定`userId`为自己子女来创建DailyTask，并在权限校验时放行（目前如果targetUserId≠自己且不是父母关系就拒绝访问）。前端也应提供家长界面去查看和新增孩子的计划任务。目前这方面功能略有不足，需要扩展。

* **任务备注/反馈**：需求中特别提出“是否支持备注”。按照设计，孩子可以在完成任务时填写心得或备注，家长也可以反馈意见。代码层面已经提供了对应字段：DailyTask包含`notes`（计划或完成时的备注）和`evidenceText`（文本形式的完成证明，可视为心得），家长审批则有`approvalNotes`。但需检查前端UI上是否明确展示和引导填写这些备注。例如孩子完成任务时，应用应提示“填写心得”让其记录在evidenceText或notes中。目前的实现满足“支持备注”这一要求，但在产品上可能需要强化UX：确保孩子知道可以写心得，家长审批时能看到并回复。这属于**体验层面的差距**，功能本身已有。

* **积分结算时机与家长确认**：按照预期，任务积分应与家长确认机制挂钩，避免孩子未经家长认可就获取积分。当前实现中，**基础积分**在学生点击完成任务时立即计入：后端直接将pointsEarned加到用户积分，即使家长稍后可能拒绝任务。这和理想流程有偏差——理应在家长**批准**后才最终给予积分。虽然家长拒绝时代码尝试将任务状态改回未完成，但**没有撤销已加的积分**。这会造成孩子账户积分偏多，除非家长手动扣回。理想方案是：完成打卡时**暂存**积分待审核，家长审批通过再把积分正式计入，审批拒绝则不计分或扣回。【当前差距】在于需要调整积分结算逻辑，将“实时加分”改为“审批通过后加分”。

* **任务拒绝后的处理**：延续上点，家长拒绝任务目前仅改变状态，没有进一步动作。预期行为可能是：标记任务无效、不计分，提示孩子重试。差距具体体现在**积分**和**任务周期**两方面：一是前述未扣积分的问题，二是任务状态如何处理。代码将状态设为`in_progress`，意味着任务仍可再次完成；这种实现基本合理，但还可考虑通知孩子原因（approvalNotes已有）以及后续是否允许再次提交。如果允许重复提交，需要前端支持让孩子在被拒任务上重新上传证据并标记完成。**小结**：需要完善拒绝分支的业务流程和数据处理，使其符合预期的“家长不认可则不得分、可重做”的要求。

* **每日/每周积分上限机制**：需求强调了积分**平衡**，包括每日或每周上限。当前系统具备每日按活动类别的限制设置，但**尚未**配置一个**全局每日上限**（例如每天最多获得多少分）或**每周合计上限**。PointsRule的dailyLimit主要用于单类活动，如运动类每天最多3分（可在PointsRule里体现），但如果孩子涉猎多种任务，当日总分可能没有硬性限制。此外，每周积分限制在实现上也比较松散：weeklyAccumulationLimit存在于配置，却没有自动检查。**差距**在于系统需要更严格的限制 enforcement，例如：定义一个每日总积分N的上限，后端在累加积分时检查totalDailyPoints + 新增是否超过上限，超出则只记入上限部分或直接拒绝打卡；每周上限则可以通过在周末检查accumulatedPoints是否>Limit，超过则建议家长为孩子安排额外奖励或强制清零等方式实现。目前这些逻辑未实现，需要根据家庭实际规则补充。

* **积分兑换规则完善**：现有兑换机制基本涵盖了**游戏时间**和**特殊奖励**两类，但还有提升空间：

  * *游戏时间兑换*功能已经实现，并与积分获取联动良好。不过，可考虑增加对**每日游戏时间总量**的限制提醒。例如GameTimeConfig定义了`dailyGameTimeLimit`（每日游戏时长上限），目前系统在兑换时没有直接引用这个值来限制兑换额度。如果有设定比如“每天最多玩2小时”，系统应在孩子尝试兑换过多时间时给出警告或禁止，这一点需确认是否在UI层面处理了。如果没有，则可在兑换接口或前端增加校验。
  * *特殊奖励兑换*目前缺少**前端触发**和**后端流程**支持。虽然有Redemption数据模型和旧的controller示例，但新代码中`rewardsController`并未包含创建兑换请求的逻辑，前端似乎也没有对应入口（README提到“积分兑换管理-审批积分兑换请求”属于家长端功能）。推测可能尚未完成或正在进行。因此，与预期的“支持兑换规则”相比，系统**缺少**一个让孩子选择特殊奖励并扣减积分的完整流程。这需要实现如下流程：孩子在前端选定奖励->触发请求->后端`createRedemption`记录请求、扣积分（或冻结积分）->家长在其端审批->后端`updateRedemptionStatus`兑现或返还积分。只有完成这闭环，才能真正说支持了**兑换规则**中“用积分换实体奖励”的部分。目前这方面是功能空缺，需要重点开发。
  * 兑换逻辑的**安全性**也需注意：比如同一积分不能被多次兑换（避免竞态条件），以及兑换请求被拒绝时是否返还积分。这些细节在现有实现里部分考虑了（如拒绝时没有扣积分，只是在批准时才扣除），但我们要确保新实现也遵循。

* **单用户 vs 多用户场景**：需求明确“不考虑多用户扩展”，即应用假定只有一对家长-孩子使用，不需要支持多个独立家庭同时使用。在现有实现中，已经有多用户、多孩子架构（可以注册多个用户，家长账户可以关联多个children）。这一点不是错误，但在部署时需配置初始用户或简化体验。例如可以**省去注册流程**，直接预置一个家长和一个孩子账户用于登录；或在UI上隐藏不需要的多用户功能（如家庭排行榜在单子女情况下意义不大）。虽然代码本身无需大改，为了契合实际需求场景，我们可以在交付时调整配置，使应用更专注于单个家庭。这属于**配置层面的差距**。

* **部署方式**：系统已经提供了在阿里云等服务器上的部署方案，包括Nginx反向代理配置和PM2进程管理。前后端既可分离部署（前端构建后由静态服务器或Nginx托管，后端提供API）也可集成部署（Express静态服务前端文件）。满足需求所说“两者均可”。这里没有功能差距，但需要注意实际部署时的调优：确保MongoDB连接、安全设置（JWT密钥、CORS）正确。由于这一部分主要是运维方面，开发上只要根据文档操作即可。

综上，主要差距集中在**细节完善**和**少量新功能开发**，例如：家长指派任务、积分结算延后、积分上限强制、兑换特殊奖励流程等。接下来给出详细的ToDo开发清单。

## ToDo 开发清单

（以下清单按照功能模块分类，列出需开发或改进的事项，以满足上述差距。每项任务尽量原子化，便于后续逐一实现和测试。）

### 📝 任务规划与日程模块

* **家长代孩子创建任务计划**：扩展任务规划接口，允许家长用户调用时指定孩子ID作为执行人。例如在`POST /dailyTasks`请求中提供`userId`（或在路径中明确child标识）。后端需调整校验逻辑，检测`req.user.role==='parent'`且目标userId属于其children则授权创建。【现状】当前仅允许给自己创建，应解除父母为子女添加的限制。前端家长端界面也增加“为孩子新增任务”入口，提供任务选择和日期等输入。

* **任务编辑与取消**：提供修改已计划任务的功能。实现一个`PUT /dailyTasks/{id}`接口，支持更新计划时间、提醒、备注等字段（遵循和createDailyTask相同的验证规则）。这样家长或孩子可以调整尚未完成的任务计划。如果任务不想执行了，允许删除计划：前端提供“取消任务”按钮，调用后端已有的`DELETE /dailyTasks/{id}`接口删除记录。确保只能删除自己的任务或家长删除孩子的任务，符合权限规则。

* **支持重复/循环任务**：如果有需求支持每日/每周重复的任务（比如“每天练琴”），可以完善`isRecurring`逻辑。当前DailyTask定义了重复模式字段但未被实际利用。ToDo包括：在创建任务计划时，若标记为重复，则按照设定规则自动批量生成后续若干天/周的DailyTask；或由后端定时任务每日生成。此为次要优化，可根据实际需要排期实现。

### ✅ 家长审批与积分确认模块

* **延迟积分入账至家长审批**：修改任务完成打卡流程，使基础积分先记入DailyTask但**不立即**累加到User总积分。在`updateDailyTaskStatus`处理中，当任务status变为`completed`时，去掉直接`$inc`用户points的操作。改为在家长**approve**时再加分。可以在DailyTask增加一个字段如`pendingPoints`记录待审批积分。当家长批准时，将pendingPoints加入User.points；若拒绝则取消积分。此改动需要小心处理并发和数据一致性，确保不会重复加分或漏加分。

* **拒绝任务扣除积分**：如果不采用上述延迟方案，也至少在家长拒绝时扣回积分。【方案】在`approveTask`的拒绝分支中，执行将User.points减去该DailyTask.pointsEarned的操作，并将DailyTask的pointsEarned清零或单独记一个`rejectedPoints`。【注意】避免出现负分，可取`Math.max(user.points - pointsEarned, 0)`。【引用】当前代码有提示但未实现扣分，需要补充这部分逻辑。同时，将DailyTask.pointsEarned设为0可以表示此次任务无效。这样确保拒绝后孩子总积分不包含未经认可的部分。

* **审批流程完善**：前端在家长审批界面中，应显示孩子提交的**备注和证据**，以便家长据此决定。实现家长查看大图/视频的功能（如点击缩略图放大预览，前端components已有MediaPreview可以用）。审批对话框中加入“审批意见”文本框和“奖励积分”输入框（整数）。家长点击通过时，这些内容通过API发送到后端（调用`approveTask`），后端据此更新approvalNotes和bonusPoints。确保前端拿到响应后，实时更新任务状态列表：从Pending移至Approved或Rejected，并显示家长填写的备注。

* **多任务批量审批**（可选）：如果家长经常需要审批多个任务，可考虑添加“全部通过”或勾选批量审批的功能。后端已经有BatchApprovalRequest类型且可能支持批量操作。实现一个`POST /dailyTasks/approveBatch`，家长一次提交多个dailyTaskIds及统一或分别的备注/加分。这个优化在任务量大时提高效率，非紧急需求，视时间决定是否实现。

### 🎯 积分机制与限制模块

* **积分规则校准**：检查并完善PointsRule配置数据，使其贴合实际奖励计划。例如，根据策划案：

  * 日记类任务：basePoints应为2分，每50字+1分，上限+10分；代码中已在默认规则配置体现，确保这些规则在数据库初始化时导入（可能通过`initializeDefaultPointsRules`一次性写入）。
  * 运动类任务：建议每10分钟1分，每日**封顶3分**。确保有PointsRule.activity=`general_exercise`且dailyLimit=3；如果没有，需要创建。类似地，音乐练习、编程游戏等类别，也根据文档调节basePoints和bonus。
  * 难度倍率：设定easy=1.0, medium=1.2, hard=1.5（或1.0/1.5/2.0等）映射到PointsRule.multipliers.difficulty，存入数据库。这样代码计算积分时会自动应用。提供一个简单界面或配置文件给家长调整这些倍率也是可选项，便于个性化平衡。
  * 将上述积分规则以文档形式告知家长和孩子，让奖励机制透明、公平。

* **每日积分上限**：实现**全局日上限**策略。例如设定“每天最多获得20分”（具体值家长可配置）。技术上，UserPointsLimit已有totalDailyPoints，可以在每日任务完成后判断：如果将新增积分后totalDailyPoints超过上限，则：一种做法是**截断**超出部分（例如当天还差3分到上限，而任务应给5分，则只给3分达到上限，提醒孩子已达当日上限）；另一种是直接禁止并通知“今日积分已达上限，任务不再计分”。考虑用户体验，建议采取前者：给剩余额度的积分，任务算完成但额外努力不计分，并提示原因。实现细节：可在`calculateConfigurablePoints`或打卡完成后、写入UserPointsLimit前，比较totalDailyPoints+pointsResult.totalPoints vs 上限值，实现上述逻辑。上限值可存于配置（如GameTimeConfig.dailyPointsLimit）或直接写死一个合理值。

* **每周积分上限/清零**：利用GameTimeConfig.weeklyAccumulationLimit参数控制孩子可以累积的未兑换积分数。例如设为100分，则如果孩子积分余额超过100，家长应引导他兑换一部分为游戏时间或奖励，否则超过部分可能**清零**（具体规则家长定）。实现上，可每周（日历周或连续7天）检查一次User.points或UserPointsLimit.accumulatedPoints是否超过限制，超出则：

  * 简单策略：将超出的部分从accumulatedPoints减掉，不影响User.points（因为User.points包含已用未用所有积分，总积分一般不扣，但可以设置新积分获取如果超阈值就浪费掉）。这种惩罚较严厉，不一定适用所有家庭。
  * 或者软性策略：提醒家长“孩子未用积分已超过上限，建议引导兑换奖励”。这种通过通知完成，系统不自动扣分。
    初版可实现**每周提醒**：统计每周日孩子的积分使用情况，如果剩余积分>上限，则在家长端仪表板显示提醒消息。具体实现可在`getWeeklyStats`或新建一个定时任务Query来计算。

* **负积分与扣分机制**（视需求）：策划中提到可以扣分来惩戒不良行为。目前系统未直接支持负积分，但实现并不复杂——家长可以有权限直接减少孩子的User.points或创建一个“扣分任务”。我们可以提供一个**扣分接口/按钮**给家长，在特殊情况下调用，比如`POST /users/{childId}/deductPoints`，参数是扣多少分和理由，后台就`$inc: {points: -X}`更新并记录日志。这一功能可选实现，确保积分体系既有正向奖励也能适度惩戒。实现时要防止points变负，可下限0。

### 🎁 积分兑换与奖励模块

* **特殊奖励兑换流程**：开发**积分兑换请求**功能，使孩子能实际花积分换取`specialRewards`中的奖品。具体步骤：

  1. 前端孩子界面：在“积分商城”或类似页面，列出后端返回的specialRewards，标注所需积分和是否可兑换（可兑换则启用按钮）。
  2. 当孩子点击兑换某项奖励时，调用后端新建兑换请求的API（如`POST /rewards/special`或`POST /redemptions`）。请求内容包括reward标识、名称、消耗积分等。后端处理：

     * 验证积分是否足够；
     * 从User.points扣减相应积分**或者**暂时冻结这部分积分；
     * 生成一条Redemption记录存入数据库，状态设为pending。记录包含userId、奖励名称描述、积分成本等信息。
     * 返回请求成功，前端提示孩子“已提交兑换申请，等待家长审批”。
  3. 家长端：在“积分兑换审批”列表看到孩子的兑换请求，内容如“兑换XX奖励，消耗YY积分”，以及请求时间等。家长可以**批准**或**拒绝**：

     * 批准：后端将Redemption.status置为approved，记录批准人和时间，并（如果之前未扣积分）在此时扣减孩子积分。还可以在Redemption记录的notes注明备注，比如“周末带你去”之类。**重要**：批准后应当触发实际奖励兑现（这部分系统无法自动处理实物，但至少确认消耗积分）。
     * 拒绝：后端置status=rejected，释放积分（如果兑换时已经扣了积分，这里需要把积分返还给User；若兑换时只是冻结，这里解冻即可）。这样不会让孩子损失积分但得不到奖励。可以在notes注明拒绝原因或协商结果。
  4. 前端反馈：家长审批操作完成后，孩子应能在自己的兑换请求列表看到状态更新：已批准的从积分余额中扣除了相应分值，标记完成；被拒绝的恢复可用积分并标记失败。可以增加通知或邮件提醒功能（可选），但前后端状态同步已足够。

  **参考**：旧版`redemptionController.ts`已经有类似逻辑，可以加以改造应用到上述流程中。需要新增路由如`GET /rewards/requests`（家长查询所有兑换请求），`POST /rewards/request`（孩子提交），`PUT /rewards/request/{id}`（家长审批）。实现完成后，“是否支持兑换规则”这一需求就真正落地了。

* **游戏时间兑换提醒**：完善游戏时间兑换部分的用户体验。主要工作在前端：

  * 当孩子准备兑换游戏时间时，如果其当天已接近`dailyGameTimeLimit`（每日游戏总时长上限，假设为2小时=120分钟），前端应提示“今日游戏时间已较长，注意休息”。可通过后端返回的数据`totalAvailableToday`等计算。
  * 教育类游戏优惠规则（前20分钟免费，每1分=10分钟）在兑换对话框中向用户提示清楚，让孩子明白学습类游戏更划算，从而平衡娱乐与学习。
  * 在“今日游戏时间”查看接口中，返回的数据包括baseGameTime=30，bonusTimeEarned，已用分钟等。前端可以用此显示“今天还可玩X分钟游戏”。当孩子尝试启动`useGameTime`超时长时，后端已做检查并会报错；前端也应根据availableTime禁用超过可用时长的选项。

* **累计积分特别大奖**：根据策划案，可以有累计积分达到某阈值就解锁的**特别奖励**（比如累计100分兑换一个大礼包）。当前specialRewards列表其实就是这类“高价值奖励”。为了鼓励孩子长期努力，家长也可在应用外实现，比如攒到100分就带孩子旅游。这在系统内体现为特殊奖励兑换。因此无新增开发，只需家长知悉这些奖励项配置即可。若需动态调整，可在前端提供家长修改specialRewards的入口或通过配置文件调整。

### 💻 前端界面与交互优化

* **学生端任务页面**：

  * **任务列表/库**：展示任务库时，应区分任务难度和类别，并显示其基础积分或积分范围，让孩子选择时有概念（比如“阅读一章书（中等，20分）”)。可以在TaskCard组件上补充显示difficulty和points字段。任务库如果很大，可按类别筛选。
  * **任务打卡表单**：在学生“今日任务”列表，每个进行中的任务提供“完成打卡”按钮。点击后弹出对话框，里面包含：

    * 可填写“完成情况描述”（文本，多行）以及上传照片/视频的控件（通过现有Upload组件）。
    * 提交按钮，调用后台完成打卡API。提交时可先调用`checkDailyPointsLimit`检查本任务对应activity当天还能得多少分，超出则提醒。如果后端不返回此检查，也可以在拿到打卡响应后，根据success=false判断是否失败超限并给出提示。
    * 提交成功后，前端更新该任务状态为“待家长确认”（在UI上也可以用灰色✅图标表示未最终完成）。
    * 对于不需证据的小任务，可以不用弹出对话框，直接点击完成即可（后端其实也支持不传evidence直接完成）。但如果策略上仍希望家长过目，也可一律走确认流程。
  * **任务状态显示**：在学生的任务列表中，清晰显示每条任务的状态（Planned计划中/Completed待审核/Approved已完成/Rejected被退回）。对于已审批的，显示获得积分数；被拒的任务可突出标记并允许重新提交（提供“重试”按钮，点击后又进入打卡上传流程）。
  * **积分与成就展示**：在学生主页或侧边栏，显示当前累计积分、已兑换奖励、以及成就徽章（铜银金钻）等，让孩子有直观的成就感。徽章信息从User.medals获取，当某一级true时显示亮色，否则灰色。

* **家长端监控与审批**:

  * **仪表盘**：家长登录后首页应看到孩子今日的任务完成概览（多少已完成待批，多少未完成等）以及**当前积分余额**和**今日新增积分**。可以利用后端weeklyStats或dailyTasks接口汇总数据。例如“今日获得10积分，累计80积分”这类提示。
  * **待审批列表**：在仪表盘或单独页面列出所有待家长审批的任务（后端`getPendingApprovalTasks`提供了数据）。每项列出任务名称、孩子提交的时间、积分值、证据概览等。家长点进某一任务可查看详情并进行审批（这部分实际上在前端有TaskApprovalWorkflow组件实现，应确保集成到页面并易于入口访问）。
  * **审批详情弹窗**：参考TaskApprovalWorkflow，这个弹窗已经设计了包含任务标题、描述、类别、孩子提交的文字和媒体、孩子备注等信息。家长可以切换查看Pending/已批/已拒任务，并针对Pending的执行审批操作。需要确保**额外积分**输入框和**审批意见**输入框在UI上明显，且家长明白奖励积分是可选项（默认为0）。当家长提交审批后，组件会更新列表。
  * **兑换请求列表**：如果实现了兑换流程，家长端应增加一个“兑换审批”页面。内容类似待审批任务列表，但项是孩子提出的奖励兑换。应显示奖励名称、所需积分、申请时间。家长点击可见详细说明（如果孩子附加了备注如“我想要这个”也显示），并有“同意兑换”或“拒绝”按钮。操作逻辑类似任务审批，背后调用`updateRedemptionStatus`接口。前端处理结果：同意则从孩子积分中扣除兑换所需分并也许需要家长在线下兑现奖励；拒绝则退还积分并提示孩子。
  * **多子女管理**：虽然当前场景单孩子，但如果不移除多用户功能，家长端界面可能有选择孩子的下拉框或切换按钮。单孩子时这些UI元素应默认选中唯一的孩子或隐藏，以减少干扰。这可以在渲染时判断children列表长度来动态控制。

* **积分/奖励页面**:

  * **积分历史**：家长和孩子或许关心积分是如何获得和花费的。可以新增“积分明细”页面，列出每次任务得分、兑换扣分记录。后端可基于DailyTask完成记录和Redemption记录合并排序生成明细。这有助于透明化积分来源和用途（防止孩子质疑积分不见了之类）。
  * **奖励兑换商城**：如前述，需要有界面让孩子查看可兑换的所有奖励项目（游戏时间兑换可以是一个独立小组件放在积分商城里或主页上部；特殊奖励则列表展示）。每个项目显示所需积分和描述，当孩子积分不足时按钮置灰或者显示“需更多积分”。当点击兑换时，进行确认（“确定花100积分兑换新游戏吗？”），然后走流程。家长端也可以有类似界面用于直接给予孩子奖励（跳过孩子申请环节），但一般还是走审批更合理。

* **提示与反馈**：完善各种交互提示：

  * 孩子完成任务后弹出动画或提示“获得X积分！等待家长确认”（可以模仿游戏通关特效增强趣味）。
  * 家长批准后，孩子端收到通知“任务XXX已通过，获得Y积分”以及家长留言，若有额外奖励积分也并入提示。
  * 家长拒绝后，孩子端收到通知“任务XXX未通过：{家长原因}，请修改后再尝试。”，引导积极改进而非挫败。
  * 当达到每日积分上限时，提示“今日积分已满{N}分，明天再接再厉！”。
  * 当孩子积分达到可以兑换某大奖时，提示“你已积攒{points}分，可以兑换【{reward}】了！”以鼓励兑换，不让激励延期太久。

### 🛠 其他逻辑及部署事项

* **完整测试**：针对新增/修改的功能编写测试用例或进行充分的手工测试。重点包括：

  * 任务流程测试：创建任务->计划->学生打卡提交->家长审批通过/拒绝，各步骤后数据库User.points和DailyTask.pointsEarned是否符合预期（特别是改动后的加减分逻辑要验证）。【例如测试审批拒绝后积分是否正确回退】。
  * 积分上限测试：模拟单日多次任务获取积分，确保当达到上限时，后续任务积分不超标或被拒绝计分，并在界面有正确提示。【可以临时将上限设小方便测试】。
  * 兑换流程测试：孩子兑换奖励请求->家长审批->积分扣减/返还正确，Redemption状态流转正确。测试免费教育游戏时间兑换边界（20分钟免费部分是否正确应用）。
  * 多并发操作下的数据一致性：例如孩子连续提交两个任务同时待批，家长批一个拒一个，用户总积分计算正确、不重复。

* **文档和指导**：更新项目文档，以反映最新功能和使用说明。包括：

  * **README**用户向部分：列出家长端和孩子端的新功能，如“家长可指定任务”“任务需审批后计分”“每日积分上限”等规则说明。
  * **配置说明**：如果新增了如dailyPointsLimit这样的环境变量或配置项，文档中告知如何设置默认值。
  * **部署指南**：阿里云部署可能涉及MongoDB实例、安全组配置等，把这些注意事项记录下来。现有DeploymentChatgpt.md可能有详细步骤，只需补充我们调整的配置项。

* **部署配置**：根据选择的部署方式进行调整：

  * 若前后端分离：确保前端API地址指向后端域名，配置CORS允许该域名请求。Nginx需要配置反向代理`/api`到Express，以及静态文件路由。
  * 若整合部署：在Express中启用静态文件服务（可能仓库已经处理好了构建产物路径）。检查`ecosystem.config.js`（PM2配置）和`nginx.conf`是否需要更新端口、域名等。
  * **安全**：由于是私人服务器，检查应用的安全设置。例如默认注册是否需要关闭（防止陌生人注册帐号），初始用户名密码要安全。JWT密钥存在.env中，要妥善保管。打开HTTPS访问等也在考虑之列（虽然开发清单中不一定要实现HTTPS，但部署时最好配合证书）。

完成以上ToDo事项后，应用将在任务规划记录和积分奖励机制方面更加贴合预期需求。孩子能够在暑期有计划地完成任务，获得及时且公平的积分奖励，家长也能方便地监督和调控整个过程，实现寓教于乐的初衷。
