<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" />
    <meta name="theme-color" content="#667eea" />
    <meta name="description" content="æš‘å‡è®¡åˆ’åŠ©æ‰‹ - è®©å­©å­çš„æš‘å‡æ›´æœ‰æ„ä¹‰" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>æš‘å‡è®¡åˆ’åŠ©æ‰‹ - æ™ºèƒ½æ—¶é—´è½´ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .mobile-safe-area {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-active {
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .touch-btn {
            min-height: 48px;
            min-width: 48px;
        }
        
        /* æ—¶é—´è½´ç›¸å…³æ ·å¼ */
        .timeline-slot {
            height: 60px;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .timeline-slot:hover {
            background-color: #f9fafb;
        }
        .timeline-slot.current-time-slot {
            background-color: #fef3c7;
        }
        
        .task-block {
            position: absolute;
            left: 80px;
            right: 10px;
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            user-select: none;
            z-index: 10;
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* ä»»åŠ¡çŠ¶æ€æ ·å¼ */
        .task-block.future {
            background: linear-gradient(135deg, #a7f3d0, #10b981);
        }
        .task-block.current {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            animation: pulse 2s infinite;
        }
        .task-block.past-incomplete {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            border-color: rgba(255,255,255,0.5);
        }
        .task-block.past-completed {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
        }
        .task-block.pending-confirm {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
        }
        .task-block.confirmed {
            background: linear-gradient(135deg, #34d399, #059669);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .task-block:active {
            transform: scale(0.98);
        }
        
        .time-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            width: 60px;
        }
        
        .current-time-line {
            position: absolute;
            left: 75px;
            right: 5px;
            height: 3px;
            background: linear-gradient(90deg, #ef4444, #dc2626);
            z-index: 30;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
            border-radius: 2px;
            transition: top 1s ease;
        }
        
        .current-time-dot {
            position: absolute;
            left: -6px;
            top: -3px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
            animation: pulse-dot 2s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        /* æ‹–æ‹½ç›¸å…³ */
        .drag-handle {
            position: absolute;
            left: 0;
            right: 0;
            height: 12px;
            cursor: ns-resize;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 15;
        }
        .task-block:hover .drag-handle {
            opacity: 1;
        }
        .drag-handle.top {
            top: -6px;
        }
        .drag-handle.bottom {
            bottom: -6px;
        }
        
        /* è¯æ®ä¸Šä¼ æ ·å¼ */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        .upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .upload-area.dragover {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .text-4xl { font-size: 2rem; }
            .text-3xl { font-size: 1.75rem; }
            .text-2xl { font-size: 1.5rem; }
            .task-block {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- é¦–é¡µ -->
    <div id="homepage" class="min-h-screen">
        <!-- Hero Section -->
        <div class="gradient-bg text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-black bg-opacity-10"></div>
            <div class="relative z-10 px-4 sm:px-6 py-12 sm:py-16 text-center">
                <div class="bounce-in">
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-3 sm:mb-4">ğŸŒŸ æš‘å‡è®¡åˆ’åŠ©æ‰‹</h1>
                    <p class="text-base sm:text-lg md:text-xl mb-6 sm:mb-8 text-blue-100">æ™ºèƒ½æ—¶é—´è½´ï¼Œè®©æ¯åˆ†é’Ÿéƒ½æœ‰æ„ä¹‰</p>
                </div>
                
                <!-- å¿«é€Ÿä½“éªŒ -->
                <div class="slide-up bg-white bg-opacity-20 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 backdrop-blur-sm max-w-md mx-auto">
                    <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">ğŸ“± å¿«é€Ÿä½“éªŒ</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <button onclick="quickLogin('student')" class="touch-btn bg-green-500 hover:bg-green-600 text-white font-medium py-3 sm:py-3 px-4 rounded-xl transition-all duration-200 active:scale-95 text-sm sm:text-base">
                            ğŸ‘¦ å­¦ç”Ÿæ¼”ç¤º
                        </button>
                        <button onclick="quickLogin('parent')" class="touch-btn bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 sm:py-3 px-4 rounded-xl transition-all duration-200 active:scale-95 text-sm sm:text-base">
                            ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶é•¿æ¼”ç¤º
                        </button>
                    </div>
                </div>

                <!-- æ­£å¼æ³¨å†Œç™»å½• -->
                <div class="slide-up bg-white bg-opacity-20 rounded-2xl p-4 sm:p-6 backdrop-blur-sm max-w-md mx-auto">
                    <h3 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4">ğŸ” æ­£å¼ä½¿ç”¨</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <button onclick="showRegister()" class="touch-btn bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 sm:py-3 px-4 rounded-xl transition-all duration-200 active:scale-95 text-sm sm:text-base">
                            ğŸ“ æ³¨å†Œè´¦æˆ·
                        </button>
                        <button onclick="showLogin()" class="touch-btn bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-3 sm:py-3 px-4 rounded-xl transition-all duration-200 active:scale-95 text-sm sm:text-base">
                            ğŸ”‘ ç™»å½•è´¦æˆ·
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½ä»‹ç» -->
        <div class="px-4 sm:px-6 py-8 sm:py-12">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 text-center mb-6 sm:mb-8">âœ¨ æ™ºèƒ½ç‰¹æ€§</h2>
            <div class="grid grid-cols-2 gap-4 sm:gap-6 max-w-2xl mx-auto">
                <div class="text-center p-3 sm:p-4">
                    <div class="text-3xl sm:text-4xl mb-2 sm:mb-3">â°</div>
                    <h3 class="font-semibold text-gray-800 mb-1 sm:mb-2 text-sm sm:text-base">æ™ºèƒ½æ—¶é—´è½´</h3>
                    <p class="text-xs sm:text-sm text-gray-600">å®æ—¶æ—¶é—´æŒ‡ç¤ºï¼Œè‡ªåŠ¨çŠ¶æ€ç®¡ç†</p>
                </div>
                <div class="text-center p-3 sm:p-4">
                    <div class="text-3xl sm:text-4xl mb-2 sm:mb-3">ğŸ¯</div>
                    <h3 class="font-semibold text-gray-800 mb-1 sm:mb-2 text-sm sm:text-base">æ‹–æ‹½è§„åˆ’</h3>
                    <p class="text-xs sm:text-sm text-gray-600">ç›´è§‚çš„æ—¶é—´è°ƒæ•´ï¼Œæ‰€è§å³æ‰€å¾—</p>
                </div>
                <div class="text-center p-3 sm:p-4">
                    <div class="text-3xl sm:text-4xl mb-2 sm:mb-3">ğŸ“¸</div>
                    <h3 class="font-semibold text-gray-800 mb-1 sm:mb-2 text-sm sm:text-base">è¯æ®ä¸Šä¼ </h3>
                    <p class="text-xs sm:text-sm text-gray-600">å®Œæˆä»»åŠ¡æ‹ç…§è¯æ˜ï¼Œå®¶é•¿ç¡®è®¤</p>
                </div>
                <div class="text-center p-3 sm:p-4">
                    <div class="text-3xl sm:text-4xl mb-2 sm:mb-3">â­</div>
                    <h3 class="font-semibold text-gray-800 mb-1 sm:mb-2 text-sm sm:text-base">ç§¯åˆ†å¥–åŠ±</h3>
                    <p class="text-xs sm:text-sm text-gray-600">å®Œæˆè·ç§¯åˆ†ï¼Œå…‘æ¢å¿ƒæ„¿å¥–åŠ±</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="main-app" class="hidden min-h-screen bg-gray-50">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="gradient-bg text-white px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-base sm:text-lg font-semibold" id="user-greeting">ğŸ‘‹ æ¬¢è¿å›æ¥</h1>
                    <p class="text-xs sm:text-sm text-blue-100" id="current-date">2025å¹´7æœˆ21æ—¥</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="bg-yellow-400 text-yellow-900 px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-bold">
                        <span id="user-points">230</span> â­
                    </div>
                    <button onclick="logout()" class="touch-btn text-white hover:text-gray-200 p-2 text-lg">
                        ğŸšª
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="px-4 sm:px-6 py-4 sm:py-6 pb-20">
            <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
            <div id="dashboard-content" class="tab-content">
                <!-- ç§¯åˆ†æ¦‚è§ˆ -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 card-shadow">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4 flex items-center">
                        ğŸ’° ç§¯åˆ†æ¦‚è§ˆ
                    </h3>
                    <div class="grid grid-cols-3 gap-3 sm:gap-4 text-center">
                        <div>
                            <div class="text-xl sm:text-2xl font-bold text-blue-600" id="total-points">350</div>
                            <div class="text-xs sm:text-sm text-gray-600">æ€»ç§¯åˆ†</div>
                        </div>
                        <div>
                            <div class="text-xl sm:text-2xl font-bold text-red-500" id="used-points">120</div>
                            <div class="text-xs sm:text-sm text-gray-600">å·²å…‘æ¢</div>
                        </div>
                        <div>
                            <div class="text-xl sm:text-2xl font-bold text-green-600" id="available-points">230</div>
                            <div class="text-xs sm:text-sm text-gray-600">ä½™é¢</div>
                        </div>
                    </div>
                </div>

                <!-- ä»»åŠ¡ç»Ÿè®¡ -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 card-shadow">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4 flex items-center">
                        ğŸ“Š ä»»åŠ¡ç»Ÿè®¡
                    </h3>
                    <div class="grid grid-cols-3 gap-3 sm:gap-4 text-center mb-3 sm:mb-4">
                        <div>
                            <div class="text-xl sm:text-2xl font-bold text-purple-600" id="total-completed">45</div>
                            <div class="text-xs sm:text-sm text-gray-600">æ€»å®Œæˆ</div>
                        </div>
                        <div>
                            <div class="text-xl sm:text-2xl font-bold text-orange-600" id="today-progress">3/5</div>
                            <div class="text-xs sm:text-sm text-gray-600">ä»Šæ—¥</div>
                        </div>
                        <div>
                            <div class="text-xl sm:text-2xl font-bold text-teal-600" id="completion-rate">60%</div>
                            <div class="text-xs sm:text-sm text-gray-600">å®Œæˆç‡</div>
                        </div>
                    </div>
                    <!-- è¿›åº¦æ¡ -->
                    <div class="w-full bg-gray-200 rounded-full h-2 sm:h-3">
                        <div class="bg-gradient-to-r from-teal-400 to-blue-500 h-2 sm:h-3 rounded-full transition-all duration-300" style="width: 60%"></div>
                    </div>
                </div>

                <!-- è·å¾—å‹‹ç«  -->
                <div class="bg-white rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 card-shadow">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4 flex items-center">
                        ğŸ† è·å¾—å‹‹ç« 
                    </h3>
                    <div class="grid grid-cols-2 gap-2 sm:gap-3" id="badges-container">
                        <div class="bg-gradient-to-r from-yellow-200 to-yellow-300 p-3 rounded-xl text-center">
                            <div class="text-xl sm:text-2xl mb-1">ğŸŒŸ</div>
                            <div class="text-xs sm:text-sm font-semibold text-yellow-800">æ—©èµ·è€…</div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-200 to-blue-300 p-3 rounded-xl text-center">
                            <div class="text-xl sm:text-2xl mb-1">ğŸ“š</div>
                            <div class="text-xs sm:text-sm font-semibold text-blue-800">é˜…è¯»è¾¾äºº</div>
                        </div>
                        <div class="bg-gradient-to-r from-green-200 to-green-300 p-3 rounded-xl text-center">
                            <div class="text-xl sm:text-2xl mb-1">ğŸƒ</div>
                            <div class="text-xs sm:text-sm font-semibold text-green-800">è¿åŠ¨å°å°†</div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-200 to-purple-300 p-3 rounded-xl text-center">
                            <div class="text-xl sm:text-2xl mb-1">ğŸ¨</div>
                            <div class="text-xs sm:text-sm font-semibold text-purple-800">åˆ›æ„ä¹‹æ˜Ÿ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è§„åˆ’é¡µé¢ -->
            <div id="planning-content" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800">ğŸ“… ä»Šæ—¥è§„åˆ’</h2>
                    <div class="text-xs text-gray-500" id="current-time-display"></div>
                </div>
                
                <!-- æ—¶é—´è½´å®¹å™¨ -->
                <div class="bg-white rounded-2xl card-shadow overflow-hidden relative">
                    <div id="timeline-container" class="relative">
                        <!-- æ—¶é—´è½´æ§½ä½å°†ç”±JSç”Ÿæˆ -->
                    </div>
                    <div id="current-time-indicator" class="current-time-line">
                        <div class="current-time-dot"></div>
                    </div>
                </div>
            </div>

            <!-- å¥–åŠ±é¡µé¢ -->
            <div id="rewards-content" class="tab-content hidden">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 sm:mb-6">ğŸ ç§¯åˆ†å•†åŸ</h2>
                <div class="space-y-3 sm:space-y-4" id="rewards-list">
                    <!-- å¥–åŠ±åˆ—è¡¨å°†ç”±JSç”Ÿæˆ -->
                </div>
            </div>

            <!-- è®°å½•é¡µé¢ -->
            <div id="records-content" class="tab-content hidden">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 sm:mb-6">ğŸ“ˆ å®Œæˆè®°å½•</h2>
                <div class="space-y-3 sm:space-y-4" id="records-list">
                    <!-- è®°å½•åˆ—è¡¨å°†ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 mobile-safe-area">
            <div class="grid grid-cols-4 py-1 sm:py-2">
                <button onclick="showTab('dashboard')" class="tab-btn tab-active touch-btn flex flex-col items-center py-2 px-1">
                    <span class="text-lg sm:text-xl mb-1">ğŸ“Š</span>
                    <span class="text-xs">ä»ªè¡¨ç›˜</span>
                </button>
                <button onclick="showTab('planning')" class="tab-btn touch-btn flex flex-col items-center py-2 px-1">
                    <span class="text-lg sm:text-xl mb-1">ğŸ“…</span>
                    <span class="text-xs">è§„åˆ’</span>
                </button>
                <button onclick="showTab('rewards')" class="tab-btn touch-btn flex flex-col items-center py-2 px-1">
                    <span class="text-lg sm:text-xl mb-1">ğŸ</span>
                    <span class="text-xs">å¥–åŠ±</span>
                </button>
                <button onclick="showTab('records')" class="tab-btn touch-btn flex flex-col items-center py-2 px-1">
                    <span class="text-lg sm:text-xl mb-1">ğŸ“ˆ</span>
                    <span class="text-xs">è®°å½•</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="task-detail-modal" class="modal hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">ä»»åŠ¡è¯¦æƒ…</h3>
                    <button onclick="closeTaskDetail()" class="text-gray-400 hover:text-gray-600 text-xl">Ã—</button>
                </div>
                
                <div class="space-y-4" id="task-detail-content">
                    <!-- ä»»åŠ¡è¯¦æƒ…å†…å®¹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- è¯æ®ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="evidence-modal" class="modal hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">ğŸ“¸ ä¸Šä¼ å®Œæˆè¯æ®</h3>
                    <button onclick="closeEvidenceModal()" class="text-gray-400 hover:text-gray-600 text-xl">Ã—</button>
                </div>
                
                <div class="space-y-6">
                    <!-- ä»»åŠ¡ä¿¡æ¯ -->
                    <div class="bg-blue-50 rounded-xl p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3" id="evidence-task-emoji">ğŸ“</span>
                            <div>
                                <h4 class="font-semibold text-blue-800" id="evidence-task-name">ä»»åŠ¡åç§°</h4>
                                <p class="text-sm text-blue-600" id="evidence-task-time">æ—¶é—´èŒƒå›´</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ‹ç…§ä¸Šä¼ åŒºåŸŸ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">ğŸ“· æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡</label>
                        <div class="upload-area" onclick="triggerImageUpload()">
                            <div id="upload-prompt" class="text-center">
                                <div class="text-4xl mb-3">ğŸ“¸</div>
                                <p class="text-gray-600 mb-2 font-medium">ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡</p>
                                <p class="text-xs text-gray-500">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤§5MB</p>
                            </div>
                            <div id="image-preview-container" class="hidden">
                                <img id="image-preview" class="image-preview" />
                                <button type="button" onclick="removeImage()" class="mt-2 text-red-500 text-sm hover:text-red-700">
                                    ğŸ—‘ï¸ é‡æ–°é€‰æ‹©
                                </button>
                            </div>
                        </div>
                        <input type="file" id="image-upload" accept="image/*" capture="camera" style="display: none;" onchange="handleImageUpload(event)">
                    </div>
                    
                    <!-- å®Œæˆè¯´æ˜ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ å®Œæˆè¯´æ˜</label>
                        <textarea 
                            id="evidence-notes"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                            rows="4"
                            placeholder="è¯·æè¿°æ‚¨æ˜¯å¦‚ä½•å®Œæˆè¿™ä¸ªä»»åŠ¡çš„...&#10;ä¾‹å¦‚ï¼šè·‘æ­¥30åˆ†é’Ÿï¼Œè·¯çº¿æ˜¯å°åŒºå…¬å›­ç»•è¡Œ3åœˆï¼Œå¿ƒç‡ä¿æŒåœ¨åˆç†èŒƒå›´ã€‚"
                        ></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <p class="text-xs text-gray-500">è¯¦ç»†è¯´æ˜æœ‰åŠ©äºå®¶é•¿æ›´å¥½åœ°äº†è§£å®Œæˆæƒ…å†µ</p>
                            <span class="text-xs text-gray-400" id="char-counter">0/200</span>
                        </div>
                    </div>
                    
                    <!-- å®Œæˆæ—¶é—´ç¡®è®¤ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">â° å®é™…å®Œæˆæ—¶é—´</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input 
                                type="time" 
                                id="actual-start-time"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                            <input 
                                type="time" 
                                id="actual-end-time"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ç¡®è®¤å®é™…å®Œæˆçš„æ—¶é—´æ®µ</p>
                    </div>
                    
                    <!-- æŒ‰é’®ç»„ -->
                    <div class="flex space-x-3 pt-4 border-t border-gray-200">
                        <button onclick="closeEvidenceModal()" class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                            å–æ¶ˆ
                        </button>
                        <button onclick="submitEvidence()" id="submit-evidence-btn" class="flex-1 py-3 px-4 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            ğŸ“¤ æäº¤è¯æ®
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€
        let currentUser = null;
        let currentTab = 'dashboard';
        let isDemo = false;
        let tasks = [];
        let draggedTask = null;
        let dragMode = null;
        let currentImageFile = null;
        let isDragging = false;
        let clickStartTime = 0;

        // æ—¶é—´ç›¸å…³
        const timeSlots = [];
        for (let hour = 0; hour <= 23; hour++) {
            for (let minute = 0; minute < 60; minute += 30) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
            }
        }

        // æ¨¡æ‹Ÿæ•°æ®
        const mockRewards = [
            { id: 1, title: 'é¢å¤–æ¸¸æˆæ—¶é—´30åˆ†é’Ÿ', cost: 50, emoji: 'ğŸ®' },
            { id: 2, title: 'é€‰æ‹©ä»Šæ™šçœ‹çš„ç”µå½±', cost: 30, emoji: 'ğŸ¬' },
            { id: 3, title: 'å‘¨æœ«å¤–å‡ºæ´»åŠ¨', cost: 100, emoji: 'ğŸˆ' },
            { id: 4, title: 'è´­ä¹°å°ç¤¼ç‰©', cost: 80, emoji: 'ğŸ' },
            { id: 5, title: 'ç¡å‰æ•…äº‹æ—¶é—´', cost: 20, emoji: 'ğŸ“–' },
            { id: 6, title: 'é€‰æ‹©åˆé¤èœå•', cost: 40, emoji: 'ğŸ•' },
        ];

        const mockRecords = [
            { id: 1, title: 'é˜…è¯»20åˆ†é’Ÿ', emoji: 'ğŸ“š', points: 10, time: 'ä»Šå¤© 14:30', color: 'green' },
            { id: 2, title: 'æ•´ç†æˆ¿é—´', emoji: 'ğŸ§¹', points: 8, time: 'ä»Šå¤© 10:15', color: 'blue' },
            { id: 3, title: 'ç»ƒä¹ é’¢ç´', emoji: 'ğŸ¹', points: 12, time: 'æ˜¨å¤© 19:15', color: 'purple' },
            { id: 4, title: 'æ™¨ç»ƒ30åˆ†é’Ÿ', emoji: 'ğŸƒâ€â™‚ï¸', points: 15, time: 'æ˜¨å¤© 07:00', color: 'orange' },
            { id: 5, title: 'å­¦ä¹ ç¼–ç¨‹', emoji: 'ğŸ’»', points: 20, time: 'å‰å¤© 16:20', color: 'teal' },
        ];

        // åˆå§‹åŒ–ç¤ºä¾‹ä»»åŠ¡
        function initializeTasks() {
            tasks = [
                {
                    id: 1,
                    name: 'æ™¨ç»ƒ',
                    startTime: '07:00',
                    endTime: '07:30',
                    difficulty: 'medium',
                    selfPoints: 15,
                    status: 'confirmed',
                    emoji: 'ğŸƒâ€â™‚ï¸'
                },
                {
                    id: 2,
                    name: 'é˜…è¯»æ—¶é—´',
                    startTime: '14:00',
                    endTime: '14:30',
                    difficulty: 'easy',
                    selfPoints: 10,
                    status: 'planning',
                    emoji: 'ğŸ“š'
                },
                {
                    id: 3,
                    name: 'è‹±è¯­å­¦ä¹ ',
                    startTime: '16:00',
                    endTime: '17:00',
                    difficulty: 'hard',
                    selfPoints: 20,
                    status: 'planning',
                    emoji: 'ğŸ“–'
                }
            ];
        }

        // é¡µé¢æ˜¾ç¤ºå‡½æ•°
        function showHomepage() {
            document.getElementById('homepage').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            console.log('showMainApp called, currentUser:', currentUser);
            document.getElementById('homepage').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUserInfo();
            updateCurrentDate();
            setupUserInterface();
            loadTabContent();
            startTimeUpdater();
        }

        // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®ç•Œé¢
        function setupUserInterface() {
            console.log("setupUserInterface called");
            console.log("currentUser:", currentUser);
            const isParent = currentUser && currentUser.role === 'parent';
            console.log('isParent:', isParent);
            
            // æ›´æ–°åº•éƒ¨å¯¼èˆª
            const bottomNav = document.querySelector('.fixed.bottom-0 .grid');
            console.log('bottomNav found:', !!bottomNav);
            if (isParent) {
                bottomNav.innerHTML = `
                    <button onclick="showTab('dashboard')" class="tab-btn tab-active touch-btn flex flex-col items-center py-2 px-1">
                        <span class="text-lg sm:text-xl mb-1">ğŸ“Š</span>
                        <span class="text-xs">æ€»è§ˆ</span>
                    </button>
                    <button onclick="showTab('monitoring')" class="tab-btn touch-btn flex flex-col items-center py-2 px-1">
                        <span class="text-lg sm:text-xl mb-1">ğŸ‘€</span>
                        <span class="text-xs">ç›‘æ§</span>
                    </button>
                    <button onclick="showTab('approval')" class="tab-btn touch-btn flex flex-col items-center py-2 px-1">
                        <span class="text-lg sm:text-xl mb-1">âœ…</span>
                        <span class="text-xs">å®¡æ ¸</span>
                    </button>
                    <button onclick="showTab('management')" class="tab-btn touch-btn flex flex-col items-center py-2 px-1">
                        <span class="text-lg sm:text-xl mb-1">âš™ï¸</span>
                        <span class="text-xs">ç®¡ç†</span>
                    </button>
                `;
            }
            
            // æ·»åŠ å®¶é•¿ä¸“ç”¨å†…å®¹åŒºåŸŸ
            if (isParent) {
                const contentArea = document.querySelector('.px-4.sm\\:px-6.py-4');
                const parentContent = `
                    <!-- å®¶é•¿ç›‘æ§é¡µé¢ -->
                    <div id="monitoring-content" class="tab-content hidden">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 sm:mb-6">ğŸ‘€ å­©å­æ´»åŠ¨ç›‘æ§</h2>
                        <div id="child-activity-list" class="space-y-3 sm:space-y-4"></div>
                    </div>

                    <!-- å®¶é•¿å®¡æ ¸é¡µé¢ -->
                    <div id="approval-content" class="tab-content hidden">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 sm:mb-6">âœ… ä»»åŠ¡å®¡æ ¸ç¡®è®¤</h2>
                        <div id="pending-approvals" class="space-y-3 sm:space-y-4"></div>
                    </div>

                    <!-- å®¶é•¿ç®¡ç†é¡µé¢ -->
                    <div id="management-content" class="tab-content hidden">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 sm:mb-6">âš™ï¸ ç§¯åˆ†ä¸å¥–åŠ±ç®¡ç†</h2>
                        <div id="management-tools" class="space-y-3 sm:space-y-4"></div>
                    </div>
                `;
                contentArea.insertAdjacentHTML('beforeend', parentContent);
            }
        }

        // å¿«é€Ÿç™»å½•æ¼”ç¤ºè´¦æˆ·
        function quickLogin(role) {
            isDemo = true;
            currentUser = {
                name: role === 'student' ? 'å°æ˜åŒå­¦' : 'å¼ å®¶é•¿',
                email: role === 'student' ? 'student@demo.com' : 'parent@demo.com',
                role: role,
                points: 230,
                totalPoints: 350,
                usedPoints: 120
            };
            initializeTasks();
            showMainApp();
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('user-greeting').textContent = `ğŸ‘‹ ${currentUser.name}`;
                document.getElementById('user-points').textContent = currentUser.points;
                document.getElementById('total-points').textContent = currentUser.totalPoints;
                document.getElementById('used-points').textContent = currentUser.usedPoints;
                document.getElementById('available-points').textContent = currentUser.points;
            }
        }

        // æ›´æ–°å½“å‰æ—¥æœŸ
        function updateCurrentDate() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('current-date').textContent = dateStr;
        }

        // å¯åŠ¨æ—¶é—´æ›´æ–°å™¨
        function startTimeUpdater() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 30000);
        }

        // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤ºå’Œæ—¶é—´è½´æŒ‡ç¤ºå™¨
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const currentTimeEl = document.getElementById('current-time-display');
            if (currentTimeEl) {
                currentTimeEl.textContent = `å½“å‰æ—¶é—´: ${timeStr}`;
            }
            
            updateTimelineIndicator(now);
            updateTaskStates(now);
        }

        // æ›´æ–°æ—¶é—´è½´æŒ‡ç¤ºå™¨
        function updateTimelineIndicator(now) {
            const hour = now.getHours();
            const minute = now.getMinutes();
            
            // ç°åœ¨æ”¯æŒå…¨å¤©24å°æ—¶
            const totalMinutesFromStart = hour * 60 + minute;
            const topPosition = (totalMinutesFromStart / 30) * 60;
            
            const indicator = document.getElementById('current-time-indicator');
            if (indicator) {
                indicator.style.top = `${topPosition}px`;
                indicator.style.display = 'block';
            }
            
            document.querySelectorAll('.timeline-slot').forEach((slot, index) => {
                slot.classList.remove('current-time-slot');
            });
            
            const currentSlotIndex = Math.floor(totalMinutesFromStart / 30);
            const currentSlot = document.querySelector(`[data-index="${currentSlotIndex}"]`);
            if (currentSlot) {
                currentSlot.classList.add('current-time-slot');
            }
        }

        // æ›´æ–°ä»»åŠ¡çŠ¶æ€åŸºäºå½“å‰æ—¶é—´
        function updateTaskStates(now) {
            const currentTimeStr = now.toTimeString().slice(0, 5);
            let hasChanges = false;
            
            tasks.forEach(task => {
                const oldStatus = task.status;
                
                if (task.status === 'planning') {
                    if (currentTimeStr >= task.startTime && currentTimeStr < task.endTime) {
                        task.status = 'current';
                        hasChanges = true;
                    } else if (currentTimeStr >= task.endTime) {
                        task.status = 'past-incomplete';
                        hasChanges = true;
                    }
                } else if (task.status === 'current') {
                    if (currentTimeStr >= task.endTime) {
                        task.status = 'past-incomplete';
                        hasChanges = true;
                    }
                }
            });
            
            if (hasChanges && currentTab === 'planning') {
                renderTasks();
            }
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
            });
            
            document.getElementById(tabName + '-content').classList.remove('hidden');
            event.target.closest('.tab-btn').classList.add('tab-active');
            
            currentTab = tabName;
            loadTabContent();
        }

        // åŠ è½½æ ‡ç­¾é¡µå†…å®¹
        function loadTabContent() {
            switch(currentTab) {
                case 'planning':
                    loadTimeline();
                    break;
                case 'rewards':
                    loadRewards();
                    break;
                case 'records':
                    loadRecords();
                    break;
                case 'monitoring':
                    loadMonitoring();
                    break;
                case 'approval':
                    loadApproval();
                    break;
                case 'management':
                    loadManagement();
                    break;
            }
        }

        // å®¶é•¿ä¸“ç”¨åŠŸèƒ½ - ç›‘æ§å­©å­æ´»åŠ¨
        function loadMonitoring() {
            const container = document.getElementById('child-activity-list');
            container.innerHTML = '';
            
            const mockChildActivities = [
                {
                    time: '13:25',
                    activity: 'å°æ˜å¼€å§‹æ‰§è¡Œã€é˜…è¯»æ—¶é—´ã€‘ä»»åŠ¡',
                    status: 'current',
                    emoji: 'ğŸ“š'
                },
                {
                    time: '12:45',
                    activity: 'å°æ˜å®Œæˆã€æ•´ç†æˆ¿é—´ã€‘ä»»åŠ¡ï¼Œç­‰å¾…ç¡®è®¤',
                    status: 'pending',
                    emoji: 'ğŸ§¹'
                },
                {
                    time: '07:30',
                    activity: 'å°æ˜å®Œæˆã€æ™¨ç»ƒã€‘ä»»åŠ¡ï¼Œå·²ç¡®è®¤',
                    status: 'confirmed',
                    emoji: 'ğŸƒâ€â™‚ï¸'
                },
                {
                    time: 'æ˜¨å¤© 19:15',
                    activity: 'å°æ˜å®Œæˆã€ç»ƒä¹ é’¢ç´ã€‘ä»»åŠ¡',
                    status: 'confirmed',
                    emoji: 'ğŸ¹'
                }
            ];
            
            mockChildActivities.forEach(activity => {
                const activityElement = document.createElement('div');
                let statusColor = 'gray';
                let statusText = '';
                
                switch(activity.status) {
                    case 'current':
                        statusColor = 'yellow';
                        statusText = 'è¿›è¡Œä¸­';
                        break;
                    case 'pending':
                        statusColor = 'purple';
                        statusText = 'å¾…ç¡®è®¤';
                        break;
                    case 'confirmed':
                        statusColor = 'green';
                        statusText = 'å·²ç¡®è®¤';
                        break;
                }
                
                activityElement.className = 'bg-white rounded-xl p-4 card-shadow';
                activityElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${activity.emoji}</span>
                            <div>
                                <p class="font-medium text-gray-800">${activity.activity}</p>
                                <p class="text-sm text-gray-500">${activity.time}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
                container.appendChild(activityElement);
            });
        }

        // å®¶é•¿ä¸“ç”¨åŠŸèƒ½ - ä»»åŠ¡å®¡æ ¸ç¡®è®¤
        function loadApproval() {
            const container = document.getElementById('pending-approvals');
            container.innerHTML = '';
            
            const pendingTasks = tasks.filter(task => task.status === 'pending-confirm');
            
            if (pendingTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">âœ…</div>
                        <p class="text-gray-500">æš‚æ— å¾…å®¡æ ¸çš„ä»»åŠ¡</p>
                    </div>
                `;
                return;
            }
            
            pendingTasks.forEach(task => {
                const approvalElement = document.createElement('div');
                approvalElement.className = 'bg-white rounded-xl p-4 card-shadow';
                approvalElement.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${task.emoji}</span>
                            <div>
                                <h3 class="font-semibold text-gray-800">${task.name}</h3>
                                <p class="text-sm text-gray-600">${task.startTime} - ${task.endTime}</p>
                                <p class="text-sm text-purple-600">ç”³è¯·ç§¯åˆ†: ${task.selfPoints} â­</p>
                            </div>
                        </div>
                        
                        ${task.evidenceNotes ? `
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">å®Œæˆè¯´æ˜:</h4>
                                <p class="text-sm text-gray-600">${task.evidenceNotes}</p>
                            </div>
                        ` : ''}
                        
                        ${task.evidenceImage ? `
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">å®Œæˆè¯æ®:</h4>
                                <p class="text-sm text-gray-600">ğŸ“¸ ${task.evidenceImage}</p>
                            </div>
                        ` : ''}
                        
                        <div class="flex space-x-3 pt-2">
                            <button onclick="approveTask(${task.id})" class="flex-1 py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                                âœ… ç¡®è®¤å®Œæˆ
                            </button>
                            <button onclick="rejectTask(${task.id})" class="flex-1 py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                                âŒ è¦æ±‚é‡åš
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(approvalElement);
            });
        }

        // å®¶é•¿ä¸“ç”¨åŠŸèƒ½ - ç§¯åˆ†ä¸å¥–åŠ±ç®¡ç†
        function loadManagement() {
            const container = document.getElementById('management-tools');
            container.innerHTML = `
                <div class="space-y-4">
                    <!-- ç§¯åˆ†è°ƒæ•´ -->
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <h3 class="font-semibold text-gray-800 mb-3">ğŸ’° ç§¯åˆ†è°ƒæ•´</h3>
                        <div class="flex items-center space-x-3">
                            <input type="number" id="points-adjustment" placeholder="è¾“å…¥ç§¯åˆ†æ•°é‡" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                            <button onclick="adjustPoints('add')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                + å¥–åŠ±
                            </button>
                            <button onclick="adjustPoints('subtract')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                - æ‰£é™¤
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">å¯ä»¥å› ä¸ºé¢å¤–è¡¨ç°æˆ–è¿è§„è¡Œä¸ºè°ƒæ•´ç§¯åˆ†</p>
                    </div>

                    <!-- è‡ªå®šä¹‰å¥–åŠ± -->
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <h3 class="font-semibold text-gray-800 mb-3">ğŸ è‡ªå®šä¹‰å¥–åŠ±</h3>
                        <div class="space-y-3">
                            <input type="text" id="reward-title" placeholder="å¥–åŠ±åç§°" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                            <div class="flex space-x-3">
                                <input type="number" id="reward-cost" placeholder="æ‰€éœ€ç§¯åˆ†" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                <button onclick="addCustomReward()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    æ·»åŠ å¥–åŠ±
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡æ¨¡æ¿ -->
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <h3 class="font-semibold text-gray-800 mb-3">ğŸ“ å¸¸ç”¨ä»»åŠ¡æ¨¡æ¿</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="addTaskTemplate('reading')" class="p-3 bg-blue-50 rounded-lg text-sm hover:bg-blue-100">
                                ğŸ“š é˜…è¯»30åˆ†é’Ÿ
                            </button>
                            <button onclick="addTaskTemplate('exercise')" class="p-3 bg-green-50 rounded-lg text-sm hover:bg-green-100">
                                ğŸƒâ€â™‚ï¸ è¿åŠ¨é”»ç‚¼
                            </button>
                            <button onclick="addTaskTemplate('homework')" class="p-3 bg-yellow-50 rounded-lg text-sm hover:bg-yellow-100">
                                âœï¸ å®Œæˆä½œä¸š
                            </button>
                            <button onclick="addTaskTemplate('chores')" class="p-3 bg-purple-50 rounded-lg text-sm hover:bg-purple-100">
                                ğŸ§¹ å®¶åŠ¡åŠ³åŠ¨
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // å®¶é•¿æ“ä½œå‡½æ•°
        function approveTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'confirmed';
                currentUser.points += task.selfPoints;
                currentUser.totalPoints += task.selfPoints;
                updateUserInfo();
                loadApproval();
                renderTasks();
                showToast(`âœ… å·²ç¡®è®¤ ${task.name}ï¼Œå­©å­è·å¾— ${task.selfPoints} ç§¯åˆ†`);
            }
        }

        function rejectTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'past-incomplete';
                loadApproval();
                renderTasks();
                showToast(`âŒ å·²è¦æ±‚é‡åš ${task.name}`);
            }
        }

        function adjustPoints(action) {
            const pointsInput = document.getElementById('points-adjustment');
            const points = parseInt(pointsInput.value);
            
            if (!points || points <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°é‡');
                return;
            }
            
            if (action === 'add') {
                currentUser.points += points;
                currentUser.totalPoints += points;
                showToast(`ğŸ‰ å·²å¥–åŠ± ${points} ç§¯åˆ†`);
            } else if (action === 'subtract') {
                if (currentUser.points >= points) {
                    currentUser.points -= points;
                    showToast(`âš ï¸ å·²æ‰£é™¤ ${points} ç§¯åˆ†`);
                } else {
                    showToast('ç§¯åˆ†ä½™é¢ä¸è¶³');
                    return;
                }
            }
            
            updateUserInfo();
            pointsInput.value = '';
        }

        function addCustomReward() {
            const title = document.getElementById('reward-title').value.trim();
            const cost = parseInt(document.getElementById('reward-cost').value);
            
            if (!title) {
                showToast('è¯·è¾“å…¥å¥–åŠ±åç§°');
                return;
            }
            
            if (!cost || cost <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°é‡');
                return;
            }
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ åˆ°å¥–åŠ±åˆ—è¡¨
            showToast(`ğŸ å·²æ·»åŠ è‡ªå®šä¹‰å¥–åŠ±: ${title} (${cost}ç§¯åˆ†)`);
            document.getElementById('reward-title').value = '';
            document.getElementById('reward-cost').value = '';
        }

        function addTaskTemplate(type) {
            const templates = {
                reading: { name: 'é˜…è¯»30åˆ†é’Ÿ', emoji: 'ğŸ“š', duration: 2, points: 15 },
                exercise: { name: 'è¿åŠ¨é”»ç‚¼', emoji: 'ğŸƒâ€â™‚ï¸', duration: 2, points: 20 },
                homework: { name: 'å®Œæˆä½œä¸š', emoji: 'âœï¸', duration: 4, points: 25 },
                chores: { name: 'å®¶åŠ¡åŠ³åŠ¨', emoji: 'ğŸ§¹', duration: 2, points: 10 }
            };
            
            const template = templates[type];
            if (template) {
                showToast(`ğŸ“ å·²æ·»åŠ ä»»åŠ¡æ¨¡æ¿: ${template.name}`);
                // è¿™é‡Œå¯ä»¥è‡ªåŠ¨æ·»åŠ åˆ°ä»Šæ—¥è§„åˆ’
            }
        }

        // åŠ è½½æ—¶é—´è½´
        function loadTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            
            timeSlots.forEach((timeSlot, index) => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'timeline-slot';
                slotDiv.dataset.time = timeSlot;
                slotDiv.dataset.index = index;
                
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                timeLabel.textContent = timeSlot;
                slotDiv.appendChild(timeLabel);
                
                slotDiv.addEventListener('click', (e) => {
                    if (e.target === slotDiv && !isDragging) {
                        createNewTask(timeSlot);
                    }
                });
                
                container.appendChild(slotDiv);
            });
            
            renderTasks();
            updateCurrentTime();
        }

        // æ¸²æŸ“ä»»åŠ¡
        function renderTasks() {
            document.querySelectorAll('.task-block').forEach(el => el.remove());
            
            tasks.forEach(task => {
                const taskEl = createTaskElement(task);
                document.getElementById('timeline-container').appendChild(taskEl);
            });
        }

        // åˆ›å»ºä»»åŠ¡å…ƒç´ 
        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            const statusClass = getTaskStatusClass(task);
            taskDiv.className = `task-block ${statusClass}`;
            taskDiv.dataset.taskId = task.id;
            
            const startIndex = timeSlots.indexOf(task.startTime);
            const endIndex = timeSlots.indexOf(task.endTime);
            const duration = endIndex - startIndex;
            
            taskDiv.style.top = `${startIndex * 60}px`;
            taskDiv.style.height = `${duration * 60}px`;
            
            taskDiv.innerHTML = `
                <div class="flex items-center justify-between h-full">
                    <div class="flex items-center">
                        <span class="text-lg mr-2">${task.emoji}</span>
                        <div>
                            <div class="font-semibold">${task.name}</div>
                            <div class="text-xs opacity-75">${task.startTime}-${task.endTime}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        ${getTaskStatusDisplay(task)}
                    </div>
                </div>
                <div class="drag-handle top"></div>
                <div class="drag-handle bottom"></div>
            `;
            
            // ä»»åŠ¡ç‚¹å‡»äº‹ä»¶ - æ”¹è¿›åçš„ç‰ˆæœ¬
            taskDiv.addEventListener('mousedown', (e) => {
                clickStartTime = Date.now();
                isDragging = false;
                
                if (e.target.classList.contains('drag-handle')) {
                    return; // æ‹–æ‹½æŠŠæ‰‹ä¸è§¦å‘ç‚¹å‡»
                }
                
                setupTaskDrag(taskDiv, task, e);
            });
            
            taskDiv.addEventListener('mouseup', (e) => {
                const clickDuration = Date.now() - clickStartTime;
                
                // å¦‚æœæ²¡æœ‰æ‹–æ‹½ä¸”ç‚¹å‡»æ—¶é—´çŸ­ï¼Œåˆ™è§†ä¸ºç‚¹å‡»äº‹ä»¶
                if (!isDragging && clickDuration < 200) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleTaskClick(task);
                }
                
                isDragging = false;
            });
            
            // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            taskDiv.addEventListener('touchstart', (e) => {
                clickStartTime = Date.now();
                isDragging = false;
            });
            
            taskDiv.addEventListener('touchend', (e) => {
                const clickDuration = Date.now() - clickStartTime;
                
                if (!isDragging && clickDuration < 200) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleTaskClick(task);
                }
                
                isDragging = false;
            });
            
            return taskDiv;
        }

        // è·å–ä»»åŠ¡çŠ¶æ€æ ·å¼ç±»
        function getTaskStatusClass(task) {
            const now = new Date();
            const currentTimeStr = now.toTimeString().slice(0, 5);
            
            if (task.status === 'confirmed') {
                return 'confirmed';
            } else if (task.status === 'pending-confirm') {
                return 'pending-confirm';
            } else if (task.status === 'past-completed') {
                return 'past-completed';
            } else if (currentTimeStr >= task.endTime) {
                return 'past-incomplete';
            } else if (currentTimeStr >= task.startTime && currentTimeStr < task.endTime) {
                return 'current';
            } else {
                return 'future';
            }
        }

        // è·å–ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
        function getTaskStatusDisplay(task) {
            const statusClass = getTaskStatusClass(task);
            
            switch(statusClass) {
                case 'future':
                    return '<div class="text-xs opacity-75">å¾…æ‰§è¡Œ</div>';
                case 'current':
                    return '<div class="text-xs font-bold">è¿›è¡Œä¸­</div>';
                case 'past-incomplete':
                    return '<div class="text-xs opacity-75">ç‚¹å‡»ä¸Šä¼ </div>';
                case 'past-completed':
                    return '<div class="text-xs opacity-75">å·²å®Œæˆ</div>';
                case 'pending-confirm':
                    return '<div class="text-xs opacity-75">å¾…ç¡®è®¤</div>';
                case 'confirmed':
                    return '<div class="text-xs font-bold">âœ“ å·²ç¡®è®¤</div>';
                default:
                    return '';
            }
        }

        // å¤„ç†ä»»åŠ¡ç‚¹å‡»
        function handleTaskClick(task) {
            console.log('Task clicked:', task.name, getTaskStatusClass(task)); // è°ƒè¯•ç”¨
            
            const statusClass = getTaskStatusClass(task);
            
            if (statusClass === 'past-incomplete') {
                showEvidenceModal(task);
            } else {
                showTaskDetail(task);
            }
        }

        // è®¾ç½®ä»»åŠ¡æ‹–æ‹½
        function setupTaskDrag(taskEl, task, initialEvent) {
            const statusClass = getTaskStatusClass(task);
            if (statusClass === 'confirmed' || statusClass === 'current') {
                return;
            }
            
            let startY = initialEvent.clientY || (initialEvent.touches && initialEvent.touches[0].clientY);
            let startTop = parseInt(taskEl.style.top);
            let startHeight = parseInt(taskEl.style.height);
            let hasDragged = false;
            
            // ç¡®å®šæ‹–æ‹½æ¨¡å¼
            if (initialEvent.target.classList.contains('drag-handle')) {
                if (initialEvent.target.classList.contains('top')) {
                    dragMode = 'resize-top';
                } else {
                    dragMode = 'resize-bottom';
                }
            } else {
                dragMode = 'move';
            }
            
            function onMouseMove(e) {
                const currentY = e.clientY || (e.touches && e.touches[0].clientY);
                const deltaY = currentY - startY;
                
                if (Math.abs(deltaY) > 5 && !hasDragged) {
                    isDragging = true;
                    hasDragged = true;
                }
                
                if (isDragging) {
                    const slotHeight = 60;
                    const deltaSlots = Math.round(deltaY / slotHeight);
                    
                    if (dragMode === 'move') {
                        const newTop = Math.max(0, Math.min(startTop + deltaSlots * slotHeight, (timeSlots.length - 1) * slotHeight));
                        taskEl.style.top = `${newTop}px`;
                    } else if (dragMode === 'resize-top') {
                        const newTop = Math.max(0, startTop + deltaSlots * slotHeight);
                        const newHeight = Math.max(slotHeight, startHeight - deltaSlots * slotHeight);
                        taskEl.style.top = `${newTop}px`;
                        taskEl.style.height = `${newHeight}px`;
                    } else if (dragMode === 'resize-bottom') {
                        const newHeight = Math.max(slotHeight, startHeight + deltaSlots * slotHeight);
                        taskEl.style.height = `${newHeight}px`;
                    }
                }
            }
            
            function onMouseUp() {
                if (isDragging && hasDragged) {
                    updateTaskFromDOM(taskEl, task);
                }
                
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.removeEventListener('touchmove', onMouseMove);
                document.removeEventListener('touchend', onMouseUp);
                
                // å»¶è¿Ÿé‡ç½®æ‹–æ‹½çŠ¶æ€
                setTimeout(() => {
                    isDragging = false;
                    hasDragged = false;
                    dragMode = null;
                }, 100);
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('touchmove', onMouseMove);
            document.addEventListener('touchend', onMouseUp);
        }

        // ä»DOMæ›´æ–°ä»»åŠ¡æ•°æ®
        function updateTaskFromDOM(taskEl, task) {
            const top = parseInt(taskEl.style.top);
            const height = parseInt(taskEl.style.height);
            const startSlotIndex = Math.round(top / 60);
            const duration = Math.round(height / 60);
            const endSlotIndex = startSlotIndex + duration;
            
            task.startTime = timeSlots[startSlotIndex];
            task.endTime = timeSlots[Math.min(endSlotIndex, timeSlots.length - 1)];
            
            renderTasks();
        }

        // åˆ›å»ºæ–°ä»»åŠ¡
        function createNewTask(startTime) {
            const startIndex = timeSlots.indexOf(startTime);
            const endTime = timeSlots[Math.min(startIndex + 1, timeSlots.length - 1)];
            
            const newTask = {
                id: Date.now(),
                name: 'æ–°ä»»åŠ¡',
                startTime: startTime,
                endTime: endTime,
                difficulty: 'medium',
                selfPoints: 10,
                status: 'planning',
                emoji: 'ğŸ“'
            };
            
            tasks.push(newTask);
            showTaskDetail(newTask);
        }

        // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
        function showTaskDetail(task) {
            const modal = document.getElementById('task-detail-modal');
            const content = document.getElementById('task-detail-content');
            
            content.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä»»åŠ¡åç§°</label>
                    <input 
                        type="text" 
                        id="task-name"
                        value="${task.name}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¶é—´</label>
                        <select id="task-start-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${timeSlots.map(time => `<option value="${time}" ${time === task.startTime ? 'selected' : ''}>${time}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç»“æŸæ—¶é—´</label>
                        <select id="task-end-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            ${timeSlots.map(time => `<option value="${time}" ${time === task.endTime ? 'selected' : ''}>${time}</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ä»»åŠ¡éš¾åº¦</label>
                    <select id="task-difficulty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="easy" ${task.difficulty === 'easy' ? 'selected' : ''}>ç®€å• (åŸºç¡€ç§¯åˆ†)</option>
                        <option value="medium" ${task.difficulty === 'medium' ? 'selected' : ''}>ä¸­ç­‰ (1.5å€ç§¯åˆ†)</option>
                        <option value="hard" ${task.difficulty === 'hard' ? 'selected' : ''}>å›°éš¾ (2å€ç§¯åˆ†)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è‡ªè¯„ç§¯åˆ†</label>
                    <input 
                        type="number" 
                        id="task-self-points"
                        value="${task.selfPoints}"
                        min="1"
                        max="100"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <p class="text-xs text-gray-500 mt-1">æ‚¨è®¤ä¸ºå®Œæˆè¿™ä¸ªä»»åŠ¡åº”è¯¥è·å¾—å¤šå°‘ç§¯åˆ†</p>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="saveTaskDetail(${task.id})" class="flex-1 py-3 px-4 bg-blue-500 text-white rounded-xl hover:bg-blue-600">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button onclick="deleteTask(${task.id})" class="px-4 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // ä¿å­˜ä»»åŠ¡è¯¦æƒ…
        function saveTaskDetail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.name = document.getElementById('task-name').value;
                task.startTime = document.getElementById('task-start-time').value;
                task.endTime = document.getElementById('task-end-time').value;
                task.difficulty = document.getElementById('task-difficulty').value;
                task.selfPoints = parseInt(document.getElementById('task-self-points').value);
                
                renderTasks();
                closeTaskDetail();
                showToast('ä»»åŠ¡å·²ä¿å­˜ï¼');
            }
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(taskId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                tasks = tasks.filter(t => t.id !== taskId);
                renderTasks();
                closeTaskDetail();
                showToast('ä»»åŠ¡å·²åˆ é™¤');
            }
        }

        // å…³é—­ä»»åŠ¡è¯¦æƒ…
        function closeTaskDetail() {
            document.getElementById('task-detail-modal').classList.add('hidden');
        }

        // æ˜¾ç¤ºè¯æ®ä¸Šä¼ æ¨¡æ€æ¡†
        function showEvidenceModal(task) {
            console.log('Opening evidence modal for task:', task.name); // è°ƒè¯•ç”¨
            
            closeTaskDetail();
            
            document.getElementById('evidence-task-emoji').textContent = task.emoji;
            document.getElementById('evidence-task-name').textContent = task.name;
            document.getElementById('evidence-task-time').textContent = `${task.startTime} - ${task.endTime}`;
            
            document.getElementById('actual-start-time').value = task.startTime;
            document.getElementById('actual-end-time').value = task.endTime;
            
            document.getElementById('evidence-notes').value = '';
            document.getElementById('char-counter').textContent = '0/200';
            resetImageUpload();
            
            const modal = document.getElementById('evidence-modal');
            modal.dataset.taskId = task.id;
            modal.classList.remove('hidden');
        }

        // å…³é—­è¯æ®ä¸Šä¼ æ¨¡æ€æ¡†
        function closeEvidenceModal() {
            document.getElementById('evidence-modal').classList.add('hidden');
            currentImageFile = null;
        }

        // è§¦å‘å›¾ç‰‡ä¸Šä¼ 
        function triggerImageUpload() {
            document.getElementById('image-upload').click();
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }
            
            currentImageFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('upload-prompt').classList.add('hidden');
                document.getElementById('image-preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // ç§»é™¤å›¾ç‰‡
        function removeImage() {
            resetImageUpload();
        }

        // é‡ç½®å›¾ç‰‡ä¸Šä¼ 
        function resetImageUpload() {
            currentImageFile = null;
            document.getElementById('image-upload').value = '';
            document.getElementById('upload-prompt').classList.remove('hidden');
            document.getElementById('image-preview-container').classList.add('hidden');
        }

        // å­—ç¬¦è®¡æ•°
        document.addEventListener('input', function(e) {
            if (e.target.id === 'evidence-notes') {
                const length = e.target.value.length;
                const counter = document.getElementById('char-counter');
                counter.textContent = `${length}/200`;
                
                if (length > 200) {
                    counter.classList.add('text-red-500');
                    e.target.value = e.target.value.substring(0, 200);
                    counter.textContent = '200/200';
                } else {
                    counter.classList.remove('text-red-500');
                }
            }
        });

        // æäº¤è¯æ®
        function submitEvidence() {
            const taskId = parseInt(document.getElementById('evidence-modal').dataset.taskId);
            const task = tasks.find(t => t.id === taskId);
            const notes = document.getElementById('evidence-notes').value.trim();
            const startTime = document.getElementById('actual-start-time').value;
            const endTime = document.getElementById('actual-end-time').value;
            
            if (!currentImageFile) {
                showToast('è¯·ä¸Šä¼ å®Œæˆè¯æ®å›¾ç‰‡');
                return;
            }
            
            if (!notes) {
                showToast('è¯·å¡«å†™å®Œæˆè¯´æ˜');
                return;
            }
            
            if (notes.length < 10) {
                showToast('å®Œæˆè¯´æ˜è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦');
                return;
            }
            
            if (!startTime || !endTime) {
                showToast('è¯·ç¡®è®¤å®é™…å®Œæˆæ—¶é—´');
                return;
            }
            
            if (startTime >= endTime) {
                showToast('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');
                return;
            }
            
            if (task) {
                task.status = 'pending-confirm';
                task.evidenceNotes = notes;
                task.actualStartTime = startTime;
                task.actualEndTime = endTime;
                task.evidenceImage = currentImageFile.name;
                
                if (isDemo) {
                    setTimeout(() => {
                        task.status = 'confirmed';
                        currentUser.points += task.selfPoints;
                        currentUser.totalPoints += task.selfPoints;
                        updateUserInfo();
                        renderTasks();
                        showToast(`ğŸ‰ å®¶é•¿å·²ç¡®è®¤ï¼è·å¾— ${task.selfPoints} ç§¯åˆ†`);
                    }, 3000);
                }
                
                renderTasks();
                closeEvidenceModal();
                showToast('è¯æ®å·²æäº¤ï¼Œç­‰å¾…å®¶é•¿ç¡®è®¤...');
            }
        }

        // åŠ è½½å¥–åŠ±åˆ—è¡¨
        function loadRewards() {
            const container = document.getElementById('rewards-list');
            container.innerHTML = '';
            
            mockRewards.forEach(reward => {
                const canAfford = currentUser && currentUser.points >= reward.cost;
                const rewardElement = document.createElement('div');
                rewardElement.className = 'bg-white rounded-xl p-4 card-shadow';
                rewardElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl sm:text-3xl mr-3 sm:mr-4">${reward.emoji}</span>
                            <div>
                                <h3 class="font-semibold text-gray-800 text-sm sm:text-base">${reward.title}</h3>
                                <p class="text-base sm:text-lg font-bold text-blue-600">${reward.cost} â­</p>
                            </div>
                        </div>
                        <button 
                            onclick="redeemReward(${reward.id})" 
                            class="touch-btn px-3 sm:px-4 py-2 ${canAfford ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-400'} text-white rounded-lg font-medium text-xs sm:text-sm transition-all duration-200 active:scale-95"
                            ${canAfford ? '' : 'disabled'}
                        >
                            ${canAfford ? 'å…‘æ¢' : 'ç§¯åˆ†ä¸è¶³'}
                        </button>
                    </div>
                `;
                container.appendChild(rewardElement);
            });
        }

        // åŠ è½½è®°å½•åˆ—è¡¨
        function loadRecords() {
            const container = document.getElementById('records-list');
            container.innerHTML = '';
            
            mockRecords.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'bg-white rounded-xl p-4 card-shadow';
                recordElement.innerHTML = `
                    <div class="flex items-center border-l-4 border-${record.color}-500 pl-4">
                        <span class="text-2xl sm:text-3xl mr-3 sm:mr-4">${record.emoji}</span>
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-800 text-sm sm:text-base">${record.title}</h3>
                            <p class="text-xs sm:text-sm text-gray-600">${record.time} å®Œæˆ â€¢ è·å¾— ${record.points} ç§¯åˆ†</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-${record.color}-600">+${record.points}</div>
                            <div class="text-xs text-gray-500">ç§¯åˆ†</div>
                        </div>
                    </div>
                `;
                container.appendChild(recordElement);
            });
        }

        // å…‘æ¢å¥–åŠ±
        function redeemReward(rewardId) {
            const reward = mockRewards.find(r => r.id === rewardId);
            if (reward && currentUser && currentUser.points >= reward.cost) {
                currentUser.points -= reward.cost;
                currentUser.usedPoints += reward.cost;
                updateUserInfo();
                loadRewards();
                showToast(`ğŸ å…‘æ¢æˆåŠŸï¼${reward.title}`);
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-90 text-white px-6 py-3 rounded-xl z-50 slide-up text-sm max-w-xs text-center';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }

        // é€€å‡ºç™»å½•
        function logout() {
            currentUser = null;
            isDemo = false;
            tasks = [];
            currentImageFile = null;
            showHomepage();
        }

        // å®¶é•¿ä¸“ç”¨åŠŸèƒ½ - ç›‘æ§å­©å­æ´»åŠ¨
        function loadMonitoring() {
            const container = document.getElementById('child-activity-list');
            if (!container) return;
            container.innerHTML = '';
            
            const mockChildActivities = [
                {
                    time: '13:25',
                    activity: 'å°æ˜å¼€å§‹æ‰§è¡Œã€é˜…è¯»æ—¶é—´ã€‘ä»»åŠ¡',
                    status: 'current',
                    emoji: 'ğŸ“š'
                },
                {
                    time: '12:45',
                    activity: 'å°æ˜å®Œæˆã€æ•´ç†æˆ¿é—´ã€‘ä»»åŠ¡ï¼Œç­‰å¾…ç¡®è®¤',
                    status: 'pending',
                    emoji: 'ğŸ§¹'
                },
                {
                    time: '07:30',
                    activity: 'å°æ˜å®Œæˆã€æ™¨ç»ƒã€‘ä»»åŠ¡ï¼Œå·²ç¡®è®¤',
                    status: 'confirmed',
                    emoji: 'ğŸƒâ€â™‚ï¸'
                }
            ];
            
            mockChildActivities.forEach(activity => {
                let statusColor = 'gray';
                let statusText = '';
                
                switch(activity.status) {
                    case 'current':
                        statusColor = 'yellow';
                        statusText = 'è¿›è¡Œä¸­';
                        break;
                    case 'pending':
                        statusColor = 'purple';
                        statusText = 'å¾…ç¡®è®¤';
                        break;
                    case 'confirmed':
                        statusColor = 'green';
                        statusText = 'å·²ç¡®è®¤';
                        break;
                }
                
                const activityElement = document.createElement('div');
                activityElement.className = 'bg-white rounded-xl p-4 card-shadow';
                activityElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${activity.emoji}</span>
                            <div>
                                <p class="font-medium text-gray-800">${activity.activity}</p>
                                <p class="text-sm text-gray-500">${activity.time}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
                container.appendChild(activityElement);
            });
        }

        // å®¶é•¿ä¸“ç”¨åŠŸèƒ½ - ä»»åŠ¡å®¡æ ¸ç¡®è®¤
        function loadApproval() {
            const container = document.getElementById('pending-approvals');
            if (!container) return;
            container.innerHTML = '';
            
            const pendingTasks = tasks.filter(task => task.status === 'pending-confirm');
            
            if (pendingTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">âœ…</div>
                        <p class="text-gray-500">æš‚æ— å¾…å®¡æ ¸çš„ä»»åŠ¡</p>
                    </div>
                `;
                return;
            }
            
            pendingTasks.forEach(task => {
                const approvalElement = document.createElement('div');
                approvalElement.className = 'bg-white rounded-xl p-4 card-shadow';
                approvalElement.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${task.emoji}</span>
                            <div>
                                <h3 class="font-semibold text-gray-800">${task.name}</h3>
                                <p class="text-sm text-gray-600">${task.startTime} - ${task.endTime}</p>
                                <p class="text-sm text-purple-600">ç”³è¯·ç§¯åˆ†: ${task.selfPoints} â­</p>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-2">
                            <button onclick="approveTask(${task.id})" class="flex-1 py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                                âœ… ç¡®è®¤å®Œæˆ
                            </button>
                            <button onclick="rejectTask(${task.id})" class="flex-1 py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                                âŒ è¦æ±‚é‡åš
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(approvalElement);
            });
        }

        // å®¶é•¿ä¸“ç”¨åŠŸèƒ½ - ç§¯åˆ†ä¸å¥–åŠ±ç®¡ç†
        function loadManagement() {
            const container = document.getElementById('management-tools');
            if (!container) return;
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-white rounded-xl p-4 card-shadow">
                        <h3 class="font-semibold text-gray-800 mb-3">ğŸ’° ç§¯åˆ†è°ƒæ•´</h3>
                        <div class="flex items-center space-x-3">
                            <input type="number" id="points-adjustment" placeholder="è¾“å…¥ç§¯åˆ†æ•°é‡" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" />
                            <button onclick="adjustPoints('add')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                + å¥–åŠ±
                            </button>
                            <button onclick="adjustPoints('subtract')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                - æ‰£é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // å®¶é•¿æ“ä½œå‡½æ•°
        function approveTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'confirmed';
                currentUser.points += task.selfPoints;
                currentUser.totalPoints += task.selfPoints;
                updateUserInfo();
                loadApproval();
                renderTasks();
                showToast(`âœ… å·²ç¡®è®¤ ${task.name}ï¼Œå­©å­è·å¾— ${task.selfPoints} ç§¯åˆ†`);
            }
        }

        function rejectTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'past-incomplete';
                loadApproval();
                renderTasks();
                showToast(`âŒ å·²è¦æ±‚é‡åš ${task.name}`);
            }
        }

        function adjustPoints(action) {
            const pointsInput = document.getElementById('points-adjustment');
            const points = parseInt(pointsInput.value);
            
            if (!points || points <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°é‡');
                return;
            }
            
            if (action === 'add') {
                currentUser.points += points;
                currentUser.totalPoints += points;
                showToast(`ğŸ‰ å·²å¥–åŠ± ${points} ç§¯åˆ†`);
            } else if (action === 'subtract') {
                if (currentUser.points >= points) {
                    currentUser.points -= points;
                    showToast(`âš ï¸ å·²æ‰£é™¤ ${points} ç§¯åˆ†`);
                } else {
                    showToast('ç§¯åˆ†ä½™é¢ä¸è¶³');
                    return;
                }
            }
            
            updateUserInfo();
            pointsInput.value = '';
        }

        // æ³¨å†Œå’Œç™»å½•æŒ‰é’®ï¼ˆæš‚æ—¶æ˜¾ç¤ºæç¤ºï¼‰
        function showRegister() {
            showToast('æ³¨å†ŒåŠŸèƒ½å¼€å‘ä¸­...');
        }

        function showLogin() {
            showToast('ç™»å½•åŠŸèƒ½å¼€å‘ä¸­...');
        }

        // å®¶é•¿ä¸“ç”¨åŠŸèƒ½
        function loadMonitoring() {
            const container = document.getElementById('child-activity-list');
            if (!container) return;
            const activities = [
                { time: '13:25', activity: 'å°æ˜å¼€å§‹æ‰§è¡Œã€é˜…è¯»æ—¶é—´ã€‘ä»»åŠ¡', status: 'current', emoji: 'ğŸ“š' },
                { time: '12:45', activity: 'å°æ˜å®Œæˆã€æ•´ç†æˆ¿é—´ã€‘ä»»åŠ¡ï¼Œç­‰å¾…ç¡®è®¤', status: 'pending', emoji: 'ğŸ§¹' }
            ];
            container.innerHTML = '';
            activities.forEach(activity => {
                let color = activity.status === 'current' ? 'yellow' : 'purple';
                let text = activity.status === 'current' ? 'è¿›è¡Œä¸­' : 'å¾…ç¡®è®¤';
                const el = document.createElement('div');
                el.className = 'bg-white rounded-xl p-4 card-shadow';
                el.innerHTML = `<div class="flex items-center justify-between"><div class="flex items-center"><span class="text-2xl mr-3">${activity.emoji}</span><div><p class="font-medium text-gray-800">${activity.activity}</p><p class="text-sm text-gray-500">${activity.time}</p></div></div><span class="px-2 py-1 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800">${text}</span></div>`;
                container.appendChild(el);
            });
        }

        function loadApproval() {
            const container = document.getElementById('pending-approvals');
            if (!container) return;
            const pendingTasks = tasks.filter(task => task.status === 'pending-confirm');
            container.innerHTML = pendingTasks.length === 0 ? 
                '<div class="text-center py-8"><div class="text-4xl mb-4">âœ…</div><p class="text-gray-500">æš‚æ— å¾…å®¡æ ¸çš„ä»»åŠ¡</p></div>' : '';
            pendingTasks.forEach(task => {
                const el = document.createElement('div');
                el.className = 'bg-white rounded-xl p-4 card-shadow';
                el.innerHTML = `<div class="space-y-4"><div class="flex items-center"><span class="text-2xl mr-3">${task.emoji}</span><div><h3 class="font-semibold text-gray-800">${task.name}</h3><p class="text-sm text-gray-600">${task.startTime} - ${task.endTime}</p><p class="text-sm text-purple-600">ç”³è¯·ç§¯åˆ†: ${task.selfPoints} â­</p></div></div><div class="flex space-x-3"><button onclick="approveTask(${task.id})" class="flex-1 py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">âœ… ç¡®è®¤å®Œæˆ</button><button onclick="rejectTask(${task.id})" class="flex-1 py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">âŒ è¦æ±‚é‡åš</button></div></div>`;
                container.appendChild(el);
            });
        }

        function loadManagement() {
            const container = document.getElementById('management-tools');
            if (!container) return;
            container.innerHTML = '<div class="bg-white rounded-xl p-4 card-shadow"><h3 class="font-semibold text-gray-800 mb-3">ğŸ’° ç§¯åˆ†è°ƒæ•´</h3><div class="flex items-center space-x-3"><input type="number" id="points-adjustment" placeholder="è¾“å…¥ç§¯åˆ†æ•°é‡" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg" /><button onclick="adjustPoints(\'add\')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">+ å¥–åŠ±</button><button onclick="adjustPoints(\'subtract\')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">- æ‰£é™¤</button></div></div>';
        }

        function approveTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'confirmed';
                currentUser.points += task.selfPoints;
                currentUser.totalPoints += task.selfPoints;
                updateUserInfo();
                loadApproval();
                renderTasks();
                showToast(`âœ… å·²ç¡®è®¤ ${task.name}ï¼Œå­©å­è·å¾— ${task.selfPoints} ç§¯åˆ†`);
            }
        }

        function rejectTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.status = 'past-incomplete';
                loadApproval();
                renderTasks();
                showToast(`âŒ å·²è¦æ±‚é‡åš ${task.name}`);
            }
        }

        function adjustPoints(action) {
            const pointsInput = document.getElementById('points-adjustment');
            const points = parseInt(pointsInput.value);
            if (!points || points <= 0) { showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°é‡'); return; }
            if (action === 'add') {
                currentUser.points += points;
                currentUser.totalPoints += points;
                showToast(`ğŸ‰ å·²å¥–åŠ± ${points} ç§¯åˆ†`);
            } else if (action === 'subtract') {
                if (currentUser.points >= points) {
                    currentUser.points -= points;
                    showToast(`âš ï¸ å·²æ‰£é™¤ ${points} ç§¯åˆ†`);
                } else { showToast('ç§¯åˆ†ä½™é¢ä¸è¶³'); return; }
            }
            updateUserInfo();
            pointsInput.value = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé¦–é¡µ
        document.addEventListener('DOMContentLoaded', showHomepage);

        // ç¦ç”¨åŒå‡»ç¼©æ”¾
        document.addEventListener('touchstart', function (event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>